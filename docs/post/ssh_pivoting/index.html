<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="security, vulnhub" name="keywords">
<meta content="Alex Flores" name="author">
<meta property="og:title" content="Configuring SSH for Pivoting - SecBlog">
<meta property="og:url" content="https://sec.alexflor.es/post/ssh_pivoting/">
<meta property="og:description" content="Things have been OK for me except that I&#39;m a zombie now">
<meta property="og:type" content="website" />
<title>Configuring SSH for Pivoting | SecBlog</title>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>
<link rel="stylesheet" href="https://sec.alexflor.es/css/style.css">
<link rel="shortcut icon" href="https://sec.alexflor.es/wave.ico">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/atom-one-dark.min.css">

</head>

<body>
<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://sec.alexflor.es"><h1 class="title is-4">SecBlog</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="/categories/boot2root" target="_blank">
            <span class="icon">
              <i class="fa fa-terminal"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://github.com/audibleblink" target="_blank">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/4lex" target="_blank">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://linkedin.com/in/alex2" target="_blank">
            <span class="icon">
              <i class="fa fa-linkedin-square"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml" target="_blank">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h1 class="title">Configuring SSH for Pivoting</h1>
    <h2 class="subtitle is-5">February 2, 2017 by Alex Flores</h2>
    
    <div class="content">
      

<p>You&rsquo;re on a pentesting engagement and you&rsquo;ve discovered a dual homed machine that allows you access to a subnet
you can&rsquo;t access directly from your attack machine. Assuming you&rsquo;ve compromised at least one machine on the
initial network, you can use it as a proxy to other machines on the &ldquo;hidden&rdquo; subnet.</p>

<p>The ssh client has an often-overlooked configuration file that resides in your <code>~/.ssh</code> folder. You can
configure things in here that are specific to certain hosts or you can set default configurations for every
host. In order to access remote networks, wouldn&rsquo;t it be nice to shorten a command like:</p>

<pre><code class="language-bash.prettyprint">ssh -l user -L 127.0.0.1:5432:132.31.321.123:5432 -p 20222 -i ~/.ssh/db/id_rsa remote.server.com
</code></pre>

<p>to something like:</p>

<pre><code class="language-bash.prettyprint">ssh mount_psql
</code></pre>

<h3 id="ssh-config-file">SSH Config file</h3>

<p>This file has a <em>lot</em> of configuration options, but we&rsquo;re just going to focus on the one&rsquo;s that help us
pivot through 2+ networks.</p>

<p><strong>ControlMaster</strong></p>

<pre><code>Enables the sharing of multiple sessions over a single network connection. 
When set to ''yes'', ssh(1) will listen for connections on a control socket 
specified using the ControlPath argument. Additional sessions can connect 
to this socket using the same ControlPath
</code></pre>

<p><strong>ControlPath</strong></p>

<pre><code>Specify the path to the control socket used for connection sharing as described 
in the ControlMaster section above or the string ''none'' to disable connection 
sharing
</code></pre>

<p><strong>ProxyCommand</strong></p>

<pre><code>Specifies the command to use to connect to the server. The command string extends 
to the end of the line, and is executed with the user's shell. In the command 
string, '%h' will be substituted by the host name to connect and '%p' by the port.
</code></pre>

<p>Ok, so the first two aren&rsquo;t strictly necessary for the pivoting, but subsequent connections to the same host
will just reuse the same authenticated socket, so it&rsquo;s lighting fast.</p>

<p>If you have the passwords for all the machines in your pivot chain, the client should ask you for each of
them, but the whole process is much smoother if you upload keys to each of them. The cool thing about the ssh
config file is that any program that uses ssh on the backend, can also use this file. So if you configure a
server entry called <code>skynet</code>&hellip;</p>

<pre><code class="language-bash.prettyprint">ssh skynet
scp file.txt skynet:/tmp
rsync -avr skynet ...
ssh-copy-id -i ~/.ssh/id_rsa skynet
</code></pre>

<p>^ All of those work.</p>

<p>So let&rsquo;s configure our <code>~/.ssh/config</code> file. Let&rsquo;s also assume root login is enabled on all the machines and
that we&rsquo;ve already copied our ssh keys onto the remote machines.</p>

<pre><code class="language-bash.prettyprint">ControlMaster auto
ControlPath /tmp/ssh_mux_%h_%p_%r
ServerAliveInterval 60 

Host first_hop
  Hostname 123.123.321.123
  User root
  IdentityFile ~/.ssh/id_rsa

Host second_hop
  Hostname 321.321.345.345
  User root
  IdentityFile ~/.ssh/id_rsa
  ProxyCommand ssh -w %h:%p first_hop

Host skynet
  Hostname 666.666.666.666
  User root
  IdentityFile ~/.ssh/id_rsa
  ProxyCommand ssh -w %h:%p second_hop
</code></pre>

<p>With this configuration, we&rsquo;re able to connect to <code>skynet</code>, which is 2 subnets removed from our current one,
with the command <code>ssh skynet</code>. Likewise, if we want to create a dynamic tunnel to allow for <code>proxychains</code>
usage, <code>ssh -fNTD 9050 skynet</code> should do the trick. Then <code>proxychains nmap...</code> to your hearts content!</p>

<p>The ProxyCommand directive in <code>skynet</code> is, in a way, declaring a prerequisite ssh connection to <code>second_hop</code>.
The <code>-w</code> flag states that the client should just go ahead and forward and STDIN/OUT through the next
connection.</p>

<p>That&rsquo;s it. Go forth and PIVAAAT!</p>

<p><img src="https://az616578.vo.msecnd.net/files/2016/07/16/636042357012300047-1231186684_ross-pivot-friends.gif" alt="" /></p>

<p><strong>Additional Resources:</strong></p>

<p><a href="https://linux.die.net/man/5/ssh_config">SSH Client Configurations Docs</a></p>

    </div>
    
        <div class="nav-left">
    <a class="nav-item" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fsec.alexflor.es%2fpost%2fssh_pivoting%2f" title="Share on Facebook" target="_blank"><span class="fa fa-facebook fa-2x" aria-hidden="true"></span></a>
    <a class="nav-item" href="https://plus.google.com/share?url=https%3a%2f%2fsec.alexflor.es%2fpost%2fssh_pivoting%2f" title="Share on Google+" target="_blank"><span class="fa fa-google-plus fa-2x" aria-hidden="true"></span></a>
    <a class="nav-item" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsec.alexflor.es%2fpost%2fssh_pivoting%2f" title="Share on LinkedIn" target="_blank"><span class="fa fa-linkedin fa-2x" aria-hidden="true"></span></a>
    <a class="nav-item" href="https://twitter.com/home?status=Configuring%20SSH%20for%20Pivoting - https%3a%2f%2fsec.alexflor.es%2fpost%2fssh_pivoting%2f" title="Tweet this" target="_blank"><span class="fa fa-twitter fa-2x"></span></a>
    <a class="nav-item" href="http://www.reddit.com/submit?url=https%3a%2f%2fsec.alexflor.es%2fpost%2fssh_pivoting%2f&title=Configuring%20SSH%20for%20Pivoting" title="Share on Reddit" target="_blank"><span class="fa fa-reddit-alien fa-2x" aria-hidden="true"></span></a>
    
    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'blinksec';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <div style='margin: auto; width: 250px'><script src="https://www.hackthebox.eu/badge/1496"></script></div>
    
  </div>
</section>


<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js" integrity="sha256-+bhVTaRmJ/c07eV80nU8gD2cBBF0rYkf1txqXlrbvb0=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/dockerfile.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/javascript.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/python.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/ruby.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>



<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-12497311-8', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>



</body>
